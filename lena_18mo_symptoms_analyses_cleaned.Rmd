---
title: "lena_18mo_symptoms_analyses"
author: "Fran Querdasi"
date: "3/2/2019"
output: html_document
---

```{r setup, include=FALSE}
#Parameters

##set up CRAN
r = getOption("repos")
r["CRAN"] = "http://cran.us.r-project.org"
options(repos = r)

#load libraries
library(tidyverse)
library(Hmisc)
library(car)
library(corrr)
library(corrplot)
library(lme4)
library(ggpubr)

#get files

##Fran file paths
crisys_file <- "~/Desktop/lena_18mo_symptoms/Data/crisys_6mo_20190430.csv"
q_18mo_file <- "~/Desktop/lena_18mo_symptoms/Data/q_18month_scores_20190510.csv"
q_18mo_ages_file <- "~/Desktop/lena_18mo_symptoms/Data/q_18month_ages.csv"
demographics_file <- "~/Desktop/lena_18mo_symptoms/Data/demographics_20190510.csv"
lena_file <- "~/Desktop/lena_18mo_symptoms/Data/lena_cleaned_day1_20190510.csv"
lena_follow_and_data_file <- "~/Desktop/lena_18mo_symptoms/Data/lena_followup_and_data_20190510.csv"
baby_raceth_file <- "~/Desktop/lena_18mo_symptoms/Data/baby_race_ethnicity.csv"
ibq_file <- "~/Desktop/lena_18mo_symptoms/Data/ibq_scored_20190510.csv"
lscr_file <- "~/Desktop/lena_18mo_symptoms/Data/lscr_merged_scored_20190412.csv"

##Lucy file paths
# crisys_file <- "~/Desktop/BABIES/lena_symptoms/fran_box_data/Data_20190413/crisys_6mo_20190430.csv"
# q_18mo_file <- "~/Desktop/BABIES/lena_symptoms/fran_box_data/Data_20190413/q_18month_scores_20190413.csv"
# q_18mo_ages_file <- "~/Desktop/BABIES/lena_symptoms/fran_box_data/Data_20190413/q_18month_ages.csv"
# demographics_file <- "~/Desktop/BABIES/lena_symptoms/fran_box_data/Data_20190413/demographics_20190413.csv"
# lena_file <- "~/Desktop/BABIES/lena_symptoms/fran_box_data/Data_20190413/lena_cleaned_day1_20190413.csv"
# lena_follow_and_data_file <- "~/Desktop/BABIES/lena_symptoms/fran_box_data/Data_20190413/lena_followup_and_data_20190413.csv"
# baby_raceth_file <- "~/Desktop/BABIES/lena_symptoms/fran_box_data/Data_20190413/baby_race_ethnicity.csv"
# ibq_file <- "~/Desktop/BABIES/lena_symptoms/fran_box_data/Data_20190413/ibq_scored_20190413.csv"
# lscr_file <- "~/Desktop/BABIES/lena_symptoms/fran_box_data/Data_20190413/lscr_merged_scored_20190412.csv"
```

# Read in and join data
```{r}
lena_18mo_sym_df <-
  read_csv(q_18mo_file) %>% 
  select(
    ID, 
    itsea_symptoms,
    itsea_competence,
    baby_age_18month
  # ) %>% 
  # left_join(
  #   read_csv(q_18mo_ages_file) %>% 
  #     select(
  #       ID,
  #       baby_age_18month,
  #       baby_age_18month_int
  #     )
  ) %>% 
  left_join(
    read_csv(crisys_file) 
  ) %>% 
  left_join(
    read_csv(lscr_file) %>% 
      select(
        ID,
        num_stress_total,
        num_stress_preg,
        sum_sev,
        max_sev
      )
  ) %>% 
  left_join(
    read_csv(demographics_file) %>% 
      select(
        ID,
        education,
        annual_income,
        income_needs,
        male,
        mom_age_6mo_visit,
        mom_race,
        mom_ethnicity,
        child_race,
        childrace_describe,
        child_ethnicity
      )
  # ) %>% 
  # left_join(
  #   read_csv(baby_raceth_file) %>% 
  #     select(
  #       -childrace_describe
  #     )
  ) %>% 
  left_join(
    read_csv(lena_file) %>% 
      rename(
        baby_age_lena = age
      )
  ) #%>% 
  #left_join(
   # read_csv(ibq_file) %>% 
  #    select(
  #      ID,
  #      SUR,
  #      NEG
  #    )
#  )

lena_18mo_sym_df <-
  lena_18mo_sym_df %>% 
  filter(
    !is.na(day),
    !(ID %in% c(1019, 1020) & is.na(mom_age_6mo_visit)) #these were duplicates
    ) %>% 
  unique()  

glimpse(lena_18mo_sym_df)
  
```
#Descriptives in full dataset

Race:
1, American Indian or Alaska Native
2, Asian
3, Black or African American
4, Native Hawaiian or Other Pacific Islander
5, White
6, Other

Education:
0, No schooling completed
2, Nursery school to 8th grade
3, Some high school, no diploma
4, High school graduate, diploma or the equivalent (i.e. GED)
5, Some college credit, no degree
6, Trade/technical/vocational training
7, Associate degree
8, Bachelor's degree
9, Graduate degree
10, Other

Income:
1, $0-5,000
2, $5,001-15,000
3, $15,001-30,000
4, $30,001-60,000
5, $60,001-90,000
6, $90,001-150,000
7, Greater than $150,000
```{r}
#means and sds of continuous demographic variables
demo_summaries <-
lena_18mo_sym_df %>% 
  summarize_at(
    vars(
    baby_age_18month,
    baby_age_lena,
    duration,
    mom_age_6mo_visit
    ), 
    list(~mean, ~sd, ~min, ~max),
    na.rm = TRUE)

#counts and percentages for categorical variables (education, ethnicity, race, income)

#income
lena_18mo_sym_df %>% 
  count(annual_income) %>% 
  mutate(per = n / sum(n)) %>% 
  arrange(desc(annual_income))

lena_18mo_sym_df %>% 
  count(income_needs < 1) %>% 
  mutate(per = n / sum(n))

#mom and child ethnicity
lena_18mo_sym_df %>% 
  count(mom_ethnicity) %>% 
  mutate(per = n / sum(n))

lena_18mo_sym_df %>% 
  count(child_ethnicity) %>% 
  mutate(per = n / sum(n))

#mom and child race
lena_18mo_sym_df %>% 
  count(mom_race) %>% 
  mutate(per = n / sum(n)) %>% 
  arrange(desc(per))

lena_18mo_sym_df %>% 
  count(child_race) %>% 
  mutate(per = n / sum(n)) %>% 
  arrange(desc(per))

#mom education
lena_18mo_sym_df %>% 
  count(education) %>% 
  mutate(per = n / sum(n)) %>% 
  arrange(desc(per))
```

# Descriptives in subset with complete data

```{r}
lena_18mo_sym_df_complete <-
  lena_18mo_sym_df %>% 
  filter(
    complete.cases(lena_18mo_sym_df)
  )

#means and sds of continuous demographic variables
demo_summaries_complete <-
lena_18mo_sym_df_complete %>% 
  summarize_at(
    vars(
    baby_age_18month,
    baby_age_lena,
    duration,
    mom_age_6mo_visit
    ), 
    list(~mean, ~sd, ~min, ~max),
    na.rm = TRUE)

#counts and percentages for categorical variables (education, ethnicity, race, income)

#income
lena_18mo_sym_df_complete %>% 
  count(annual_income) %>% 
  mutate(per = n / sum(n)) %>% 
  arrange(desc(annual_income))

lena_18mo_sym_df_complete %>% 
  count(income_needs < 1) %>% 
  mutate(per = n / sum(n))

#mom and child ethnicity
lena_18mo_sym_df_complete %>% 
  count(mom_ethnicity) %>% 
  mutate(per = n / sum(n))

lena_18mo_sym_df_complete %>% 
  count(child_ethnicity) %>% 
  mutate(per = n / sum(n))
 
#mom and child race 
lena_18mo_sym_df_complete %>% 
  count(mom_race) %>% 
  mutate(per = n / sum(n)) %>% 
  arrange(desc(per))

lena_18mo_sym_df %>% 
  count(child_race) %>% 
  mutate(per = n / sum(n)) %>% 
  arrange(desc(per))

#mom education
lena_18mo_sym_df_complete %>% 
  count(education) %>% 
  mutate(per = n / sum(n)) %>% 
  arrange(desc(per))
```

# Look at distributions of data
```{r}
qplot(lena_18mo_sym_df$itsea_competence, 
      geom = "histogram",
      binwidth = .05)

qplot(lena_18mo_sym_df$itsea_symptoms, 
      geom = "histogram",
      binwidth = .05)

qplot(lena_18mo_sym_df$baby_age_18month, 
      geom = "histogram",
      binwidth = .5)

qplot(lena_18mo_sym_df$crisys_total_6mo, 
      geom = "histogram",
      binwidth = .5)

qplot(lena_18mo_sym_df$income_needs, 
      geom = "histogram",
      binwidth = .1)

qplot(lena_18mo_sym_df$education, 
      geom = "histogram",
      binwidth = .1)

qplot(lena_18mo_sym_df$baby_age_lena, 
      geom = "histogram",
      binwidth = .1)

qplot(lena_18mo_sym_df$duration, 
      geom = "histogram",
      binwidth = .5)

qplot(lena_18mo_sym_df$awc_prop, 
      geom = "histogram",
      binwidth = .05)

qplot(lena_18mo_sym_df$ctc_prop, 
      geom = "histogram",
      binwidth = .05)

qplot(lena_18mo_sym_df$cvc_prop, 
      geom = "histogram",
      binwidth = .05)

qplot(lena_18mo_sym_df$num_stress_total, 
      geom = "histogram",
      binwidth = .05)

qplot(lena_18mo_sym_df$num_stress_preg, 
      geom = "histogram",
      binwidth = .05)

qplot(lena_18mo_sym_df$max_sev, 
      geom = "histogram",
      binwidth = .05)

count(lena_18mo_sym_df, day_type)
count(lena_18mo_sym_df_complete, day_type)

```

# Look at means, std, min, max for variables of interest
```{r}
#in complete dataset
summaries_continuous <-
lena_18mo_sym_df %>% 
  summarise_at(
    vars(
      itsea_competence, 
      itsea_symptoms, 
      crisys_total_6mo_win, 
      crisys_total_6mo,
      awc_prop, 
      ctc_prop, 
      cvc_prop
      ), 
    funs(
        mean, 
        sd, 
        min, 
        max), 
    na.rm = TRUE)

#in subset with complete data
summaries_continuous <-
lena_18mo_sym_df_complete %>% 
  summarise_at(
    vars(
      itsea_competence, 
      itsea_symptoms, 
      crisys_total_6mo_win, 
      crisys_total_6mo,
      awc_prop, 
      ctc_prop, 
      cvc_prop
      ), 
    list(
        ~mean, 
        ~sd, 
        ~min, 
        ~max,
        ~median), 
    na.rm = TRUE)

#is there a way to reformat this data table?
```

# Correlation tables
```{r}
#lucy's correlation function
correlations_continuous <-
  lena_18mo_sym_df %>% 
  select(
    itsea_symptoms,
    itsea_competence,
    baby_age_18month,
    baby_age_lena,
    mom_age_6mo_visit,
    income_needs,
    crisys_neg_total_6mo_win,
    duration,
    awc_daily_rate,
    ctc_daily_rate,
    cvc_daily_rate,
    awc_prop,
    ctc_prop,
    cvc_prop,
    num_stress_total,
    num_stress_preg,
    max_sev,
    sum_sev
    #SUR,
    #NEG
  )

corr_table <- correlate(correlations_continuous)

corr_mat <- rcorr(as.matrix(correlations_continuous), type = c("pearson"))
corr_mat

# flattenCorrMatrix <- function(cormat, pmat) {
#   ut <- upper.tri(cormat)
#   data.frame(
#     row = rownames(cormat)[row(cormat)[ut]],
#     column = rownames(cormat)[col(cormat)[ut]],
#     cor  =(cormat)[ut],
#     p = pmat[ut]
#     )
# }
# 
# flattenCorrMatrix(corr_mat$r, corr_mat$p)

#Insignificant correlations are left blank
corrplot(
  corr_mat$r,
  type = "upper", order = "hclust",
  p.mat = corr_mat$P, sig.level = 0.05, insig = "blank"
)


```
# Center continuous variables & median split stress variables

```{r}
# create variables that are median splits for stress variables
lena_18mo_sym_df <-
  lena_18mo_sym_df %>% 
  mutate(
    crisys_median_split = if_else(
      crisys_neg_total_6mo_win > median(crisys_neg_total_6mo_win, na.rm = TRUE),
      "stressed", "not stressed"
    ),
    num_stress_total_median_split = if_else(
      num_stress_total > median(num_stress_total, na.rm = TRUE),
      "high lifetime stress", "low lifetime stress"
    ),
    sumsev_total_median_split = if_else(
      sum_sev > median(sum_sev, na.rm = TRUE),
      "intense stress", "not intense stress"
    )
  )

#create factor with crisys_median_split variables
#need to do this??
lena_18mo_sym_df <-
  lena_18mo_sym_df %>% 
  mutate(
    crisys_median_split_num = if_else(
      crisys_median_split == "stressed", 
      1, 0
    ),
    crisys_median_factor = as.factor(crisys_median_split_num)
  )

contrasts(lena_18mo_sym_df$crisys_median_factor) = c(-1,1)

#center continuous variables
lena_18mo_sym_df <-
  lena_18mo_sym_df %>% 
  mutate(
    awc_prop_centered = scale(awc_prop, scale = FALSE),
    itsea_symptoms_centered = scale(itsea_symptoms, scale = FALSE),
    ctc_prop_centered = scale(ctc_prop, scale = FALSE),
    cvc_prop_centered = scale(cvc_prop, scale = FALSE),
    itsea_competence_centered = scale(itsea_competence, scale = FALSE)
  )
```
#test associations among categorical variables 
```{r}
##(categorical variables = crisys_median_split, education, male, day_type)

##Is day_type related to daily rates, props, symptoms, competence?

lena_18mo_sym_df %>% 
  count(day_type)
#49 weekdays, 21 weekends

t.test(lena_18mo_sym_df$awc_daily_rate ~ lena_18mo_sym_df$day_type)
#no difference
t.test(lena_18mo_sym_df$ctc_daily_rate ~ lena_18mo_sym_df$day_type)
#no difference
t.test(lena_18mo_sym_df$cvc_daily_rate ~ lena_18mo_sym_df$day_type)
#higher cvc daily rate in weekday vs. weekend group, t(31.644) = 2.2196, p=.03374
t.test(lena_18mo_sym_df$awc_prop ~ lena_18mo_sym_df$day_type)
#ns
t.test(lena_18mo_sym_df$ctc_prop ~ lena_18mo_sym_df$day_type)
#ns
t.test(lena_18mo_sym_df$cvc_prop ~ lena_18mo_sym_df$day_type)
#ns
t.test(lena_18mo_sym_df$itsea_symptoms ~ lena_18mo_sym_df$day_type)
#ns
t.test(lena_18mo_sym_df$itsea_competence ~ lena_18mo_sym_df$day_type)
#ns

#Are there differences among stressed vs. non-stressed groups by education, income_needs, daily rates, props, itsea_symptoms, itsea_competence?

t.test(lena_18mo_sym_df$income_needs ~ lena_18mo_sym_df$crisys_median_split)
#ns, higher in not stressed
t.test(lena_18mo_sym_df$awc_daily_rate ~ lena_18mo_sym_df$crisys_median_split)
#ns, higher in stressed
t.test(lena_18mo_sym_df$ctc_daily_rate ~ lena_18mo_sym_df$crisys_median_split)
#ns
t.test(lena_18mo_sym_df$cvc_daily_rate ~ lena_18mo_sym_df$crisys_median_split)
#ns
t.test(lena_18mo_sym_df$awc_prop ~ lena_18mo_sym_df$crisys_median_split)
#ns
t.test(lena_18mo_sym_df$ctc_prop ~ lena_18mo_sym_df$crisys_median_split)
#ns
t.test(lena_18mo_sym_df$cvc_prop ~ lena_18mo_sym_df$crisys_median_split)
#ns
t.test(lena_18mo_sym_df$itsea_symptoms ~ lena_18mo_sym_df$crisys_median_split)
#higher in stressed group, t(37.844) = -2.1569, p = .037
t.test(lena_18mo_sym_df$itsea_competence ~ lena_18mo_sym_df$crisys_median_split)
#ns

```
# Main effects

```{r}
#lena variables on itsea symptoms
lena_18mo_sym_awcprop <- 
  lm(
    itsea_symptoms_centered ~ 
      awc_prop_centered,
    data = lena_18mo_sym_df 
                 )

summary(lena_18mo_sym_awcprop)
#

lena_18mo_sym_ctcprop <- 
  lm(
    itsea_symptoms ~ 
      ctc_prop_centered,
    data = lena_18mo_sym_df)

summary(lena_18mo_sym_ctcprop)
#

lena_18mo_sym_cvcprop <- 
  lm(
    itsea_symptoms ~ 
      cvc_prop_centered,
    data = lena_18mo_sym_df)
summary(lena_18mo_sym_cvcprop)
#

lena_18mo_sym_awcrate <- 
  lm(
    itsea_symptoms ~ 
      awc_daily_rate,
    data = lena_18mo_sym_df)
summary(lena_18mo_sym_awcrate)
#

lena_18mo_sym_ctcrate <- 
  lm(
    itsea_symptoms ~ 
      ctc_daily_rate,
    data = lena_18mo_sym_df)
summary(lena_18mo_sym_ctcrate)
#

lena_18mo_sym_cvcrate <- 
  lm(
    itsea_symptoms ~ 
      cvc_daily_rate,
    data = lena_18mo_sym_df)
summary(lena_18mo_sym_cvcrate)

#lscr variables on itsea symptoms
lena_18mo_sym_numstress <- 
  lm(
    itsea_symptoms ~ 
      num_stress_total,
    data = lena_18mo_sym_df)
summary(lena_18mo_sym_numstress)
#

lena_18mo_sym_sumsev <- 
  lm(
    itsea_symptoms ~ 
      sum_sev,
    data = lena_18mo_sym_df)
summary(lena_18mo_sym_sumsev)
#

lena_18mo_sym_numstress_preg <- 
  lm(
    itsea_symptoms ~ 
     num_stress_preg,
    data = lena_18mo_sym_df)
summary(lena_18mo_sym_numstress_preg)
#no main effect

lena_18mo_sym_maxsev <- 
  lm(
    itsea_symptoms ~ 
     max_sev,
    data = lena_18mo_sym_df)
summary(lena_18mo_sym_maxsev)
#no main effect

#crisys on itsea symptoms

lena_18mo_sym_crisys <- 
  lm(
    itsea_symptoms ~ 
     crisys_neg_total_6mo_win,
    data = lena_18mo_sym_df)
summary(lena_18mo_sym_crisys)

#visualize interesting stuff
lena_18mo_sym_df %>%
  ggplot(aes(ctc_prop, itsea_symptoms)) +
  geom_point() +
  geom_smooth(method ="lm")
```

#Run main analyses: lena variables * crisys

```{r}
lena_18mo_sym_int_awcprop_neg <- 
  lm(
    itsea_symptoms_centered ~ 
      baby_age_lena + crisys_neg_total_6mo_win * awc_prop_centered,
    data = lena_18mo_sym_df 
  )

summary(lena_18mo_sym_int_awcprop_neg)

lena_18mo_sym_int_awcrate_neg <- 
  lm(
    itsea_symptoms_centered ~ 
      baby_age_lena + crisys_neg_total_6mo_win * awc_daily_rate,
    data = lena_18mo_sym_df 
  )

summary(lena_18mo_sym_int_awcrate_neg)


lena_18mo_sym_int_ctcprop_neg <- 
  lm(
    itsea_symptoms_centered ~ 
      baby_age_lena + crisys_neg_total_6mo_win * ctc_prop_centered,
    data = lena_18mo_sym_df 
  )

summary(lena_18mo_sym_int_ctcprop_neg)


lena_18mo_sym_int_ctcrate_neg <- 
  lm(
    itsea_symptoms_centered ~ 
      baby_age_lena + crisys_neg_total_6mo_win * ctc_daily_rate,
    data = lena_18mo_sym_df 
  )

summary(lena_18mo_sym_int_ctcrate_neg)

```
#calculate R2 change from just interaction term in crisys x ctcrate --> 18 mo sx
```{r}
#model with all predictors separate
lena_18mo_sym_int_ctcrate_neg <- 
  lm(
    itsea_symptoms_centered ~ 
      baby_age_lena + crisys_neg_total_6mo_win + ctc_daily_rate,
    data = lena_18mo_sym_df 
  )

r2_1 <- summary(lena_18mo_sym_int_ctcrate_neg)$r.squared

#model with interaction (X = interaction)
lena_18mo_sym_int_ctcrate_negX <- 
  lm(
    itsea_symptoms_centered ~ 
      baby_age_lena + crisys_neg_total_6mo_win * ctc_daily_rate,
    data = lena_18mo_sym_df 
  )
summary(lena_18mo_sym_int_ctcrate_negX)

r2_2 <- summary(lena_18mo_sym_int_ctcrate_negX)$r.squared

#change from just predictors to predictors & interaction term
r2_change <- r2_2 - r2_1
```

#visualize ctcrate x crisys --> 18month symptoms effect
```{r}
lena_18mo_sym_df %>% 
  ggplot(
    aes(
      crisys_neg_total_6mo_win, 
      itsea_symptoms,
      color = factor(ctc_daily_rate > median(ctc_daily_rate, na.rm = TRUE))
    )
  ) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = FALSE, size = 2) +
  theme_minimal() +
  labs(
    color = "above ctc_rate median"
  )
```

#test other potential predictors (that were correlated in the correlation matrix)
```{r}

```
#models just within weekday recordings
```{r}
#create df with just weekdays
lena_18mo_sym_df_weekdays <-
  lena_18mo_sym_df %>% 
  filter(
    day_type == "weekday"
  )

lena_18mo_sym_int_awcprop_neg_weekdays <- 
  lm(
    itsea_symptoms_centered ~ 
      baby_age_lena + crisys_neg_total_6mo_win * awc_prop_centered,
    data = lena_18mo_sym_df_weekdays 
  )

summary(lena_18mo_sym_int_awcprop_neg_weekdays)

lena_18mo_sym_int_awcrate_neg_weekdays <- 
  lm(
    itsea_symptoms_centered ~ 
      baby_age_lena + crisys_neg_total_6mo_win * awc_daily_rate,
    data = lena_18mo_sym_df_weekdays 
  )

summary(lena_18mo_sym_int_awcrate_neg_weekdays)


lena_18mo_sym_int_ctcprop_neg_weekdays <- 
  lm(
    itsea_symptoms_centered ~ 
      baby_age_lena + crisys_neg_total_6mo_win * ctc_prop_centered,
    data = lena_18mo_sym_df_weekdays 
  )

summary(lena_18mo_sym_int_ctcprop_neg_weekdays)


lena_18mo_sym_int_ctcrate_neg_weekdays <- 
  lm(
    itsea_symptoms_centered ~ 
      baby_age_lena + crisys_neg_total_6mo_win * ctc_daily_rate,
    data = lena_18mo_sym_df_weekdays
  )

summary(lena_18mo_sym_int_ctcrate_neg_weekdays)
```

#visualize interactions & main effects
```{r}

count(lena_18mo_sym_df, crisys_median_split)

##CRISYS
#interactions - prop variables
lena_18mo_sym_df %>%
  filter(
    !is.na(crisys_median_split)
  ) %>% 
  ggplot(aes(awc_prop_centered, itsea_symptoms, color = crisys_median_split)) +
  geom_point() +
  geom_smooth(method ="lm")

lena_18mo_sym_df %>%
  filter(
    !is.na(crisys_median_split)
  ) %>% 
  ggplot(aes(ctc_prop_centered, itsea_symptoms, color = crisys_median_split)) +
  geom_point() +
  geom_smooth(method ="lm")

#interactions - daily rate variables
lena_18mo_sym_df %>%
  filter(
    !is.na(crisys_median_split)
  ) %>% 
  ggplot(aes(awc_daily_rate, itsea_symptoms, color = crisys_median_split)) +
  geom_point() +
  geom_smooth(method ="lm")

lena_18mo_sym_df %>%
  filter(
    !is.na(crisys_median_split)
  ) %>% 
  ggplot(aes(ctc_daily_rate, itsea_symptoms, color = crisys_median_split)) +
  geom_point() +
  geom_smooth(method ="lm")

#main effects

#prop variables
lena_18mo_sym_df %>%
  ggplot(aes(awc_prop_centered, itsea_symptoms)) +
  geom_point() +
  geom_smooth(method ="lm")

lena_18mo_sym_df %>%
  ggplot(aes(ctc_prop_centered, itsea_symptoms)) +
  geom_point() +
  geom_smooth(method ="lm")

#daily rate variables
lena_18mo_sym_df %>%
  ggplot(aes(awc_daily_rate, itsea_symptoms)) +
  geom_point() +
  geom_smooth(method ="lm")

lena_18mo_sym_df %>%
  ggplot(aes(ctc_daily_rate, itsea_symptoms)) +
  geom_point() +
  geom_smooth(method ="lm")

#LSCR
#interactions
lena_18mo_sym_df %>%
  filter(
    !is.na(num_stress_total)
  ) %>% 
  ggplot(aes(ctc_prop_centered, itsea_symptoms, color = num_stress_total_median_split)) +
  geom_point() +
  geom_smooth(method ="lm")

lena_18mo_sym_df %>%
  filter(
    !is.na(sum_sev)
  ) %>% 
  ggplot(aes(ctc_prop_centered, itsea_symptoms, color = sumsev_total_median_split)) +
  geom_point() +
  geom_smooth(method ="lm")


```
#examine LENA follow-up data
```{r}
#Within all ps with followup data and awc_prop
lena_followup_and_data <-
  read_csv(lena_follow_and_data_file)

#see if percent_mother associated with awc_depend_prop
lena_momtime_awc <- 
  lm(
    awc_prop ~ percent_mother,
    data = lena_followup_and_data 
    )
summary(lena_momtime_awc)
#association not significant (p = .69)

#cor.test (use spearman's correlation if data is weirdly distributed to check correlation)

#visualize regression
lena_followup_and_data %>% 
ggplot(aes(percent_mother, awc_prop)) +
  geom_point() +
  geom_smooth(method ="lm")

#report stats on percent_mother
lena_followup_and_data %>% 
  summarize_at(
    vars(
    percent_mother
    ), 
    list(~mean, ~sd, ~min, ~max),
    na.rm = TRUE)

#Within just subset of complete cases
 
lena_follow_complete_data <-
  lena_18mo_sym_df_complete %>% 
  left_join(
    read_csv(lena_follow_and_data_file),
    by = "ID"
  )

lena_follow_complete_data %>% 
  summarize_at(
    vars(
    percent_mother
    ), 
    list(~mean, ~sd, ~min, ~max),
    na.rm = TRUE) 

lena_follow_complete_data %>% 
  count(percent_mother) %>% 
  mutate(total = sum(!is.na(n)))

#see if percent_mother associated with weekday vs weekend
t.test(lena_follow_complete_data$percent_mother ~ lena_follow_complete_data$day_type.x)
  
```


#Regression diagnostics - focusing on most significant interaction (crisys * ctcrate)
```{r}
#assessing outliers
outlierTest(lena_18mo_sym_int_ctcrate_neg) # Bonferonni p-value for most extreme obs
#not sure why this didn't work
qqPlot(lena_18mo_sym_int_ctcrate_neg, main="QQ Plot") #qq plot for studentized resid 
leveragePlots(lena_18mo_sym_int_ctcrate_neg) # leverage plots

#calculate standardized estimates
#library(sjstats)
#no covs model
#std_beta(lena_18mo_sym_int_awc)
#covs model
#std_beta(lena_18mo_sym_int_awc_covs)

# Normality of Residuals
# qq plot for studentized resid
qqPlot(lena_18mo_sym_int_ctcrate_neg, main="QQ Plot")
# distribution of studentized residuals
# library(MASS)
# sresid <- studres(lena_18mo_sym_int_awc) 
# hist(lena_18mo_sym_int_awc, freq=FALSE, 
#    main="Distribution of Studentized Residuals") #error - x must be numeric
# xfit<-seq(min(sresid),max(sresid),length=40) 
# yfit<-dnorm(xfit) 
# lines(xfit, yfit)

#conclusions about qqplot: 
#leverage plots: 

# Evaluate Collinearity
vif(lena_18mo_sym_int_ctcrate_neg) # variance inflation factors 
sqrt(vif(lena_18mo_sym_int_ctcrate_neg)) > 2 # problem?
#may be problem (crisys and interaction)

# Global test of model assumptions
library(gvlma)
gvmodel <- gvlma(lena_18mo_sym_int_ctcrate_neg) 
summary(lena_18mo_sym_int_ctcrate_neg)
```
#simple slopes:  crisys * ctcrate interaction 
```{r}
#create new variables: high and low ctc_daily_rate
lena_18mo_sym_df <-
  lena_18mo_sym_df %>% 
  mutate(
    ctc_daily_rate_hi = scale(ctc_daily_rate, scale = F) - sd(ctc_daily_rate),
    ctc_daily_rate_low = scale(ctc_daily_rate, scale = F) + sd(ctc_daily_rate)
    # ctc_prop_hi = scale(ctc_prop, scale = F) - sd(awc_prop),
    # ctc_prop_low = scale(ctc_prop, scale = F) + sd(awc_prop)
  )


#run model with ctc_daily_rate_hi
lena_18mo_sym_ctcrate_hi <- 
  lm(
    itsea_symptoms_centered ~ 
      baby_age_lena + crisys_neg_total_6mo_win * ctc_daily_rate_hi,
    data = lena_18mo_sym_df 
  )

summary(lena_18mo_sym_ctcrate_hi)
#

#run model with ctc_daily_rate_low
lena_18mo_sym_ctcrate_low <- 
  lm(
    itsea_symptoms_centered ~ 
      baby_age_lena + crisys_neg_total_6mo_win * ctc_daily_rate_low,
    data = lena_18mo_sym_df 
  )

summary(lena_18mo_sym_ctcrate_low)

```
#probe (other interactions??) w simple slopes
```{r}
#run model everything centered again (just for kicks)
# lena_18mo_sym_int_ctc_numstress <- 
#   lm(
#     itsea_symptoms_centered ~ 
#       num_stress_total * ctc_prop_centered,
#     data = lena_18mo_sym_df 
#                  )
# summary(lena_18mo_sym_int_ctc_numstress)
# 
# 
# #run model with ctc_prop_hi
# lena_18mo_sym_numstress_ctc_hi <- 
#   lm(
#     itsea_symptoms_centered ~ 
#       num_stress_total * ctc_prop_hi,
#     data = lena_18mo_sym_df 
#                  )
# 
# summary(lena_18mo_sym_numstress_ctc_hi)
# #
# 
# #run model with ctc_prop_low
# lena_18mo_sym_numstress_ctc_low <- 
#   lm(
#     itsea_symptoms_centered ~ 
#       num_stress_total * ctc_prop_low,
#     data = lena_18mo_sym_df 
#                  )
# 
# summary(lena_18mo_sym_numstress_ctc_low)
```

#olsrr diagnostics, standardized betas: ctcrate * crisys
```{r}
##standardized betas

library(olsrr)
ols_regress_model_middle <-
ols_regress(itsea_symptoms_centered ~ 
      baby_age_lena + crisys_neg_total_6mo_win * ctc_daily_rate,
    data = lena_18mo_sym_df)
print(ols_regress_model_middle)
#ols_plot_diagnostics(lena_18mo_sym_int_awc) - not really sure why this isn't working
 #standardized betas: interaction term: -.341 (-.317, -.044); awc_prop_centered: -.150 (-.287, 1.655); crisys_total_6mo_win: .237 (-.001, .027)

ols_regress_model_high <-
ols_regress(itsea_symptoms_centered ~ 
      baby_age_lena + crisys_neg_total_6mo_win * ctc_daily_rate_hi,
    data = lena_18mo_sym_df)
print(ols_regress_model_high)
 
ols_regress_model_low <-
ols_regress(itsea_symptoms_centered ~ 
      baby_age_lena + crisys_neg_total_6mo_win * ctc_daily_rate_low,
    data = lena_18mo_sym_df)
print(ols_regress_model_low)


##olsrr diagnostics
plot(lena_18mo_sym_int_awcrate_neg)
#residuals vs. fitted should be straight line
#normal q-q should follow line
#scale location shows if residuals are spread equally along the ranges of predictors. This is how you can check the assumption of equal variance (homoscedasticity). It’s good if you see a horizontal line with equally (randomly) spread points.
#residuals vs leverage: allows identification of potentially influential outliers to the model. Influential ones are outside cook's distance. 

```
