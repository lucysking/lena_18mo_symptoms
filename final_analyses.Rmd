---
title: "Association of linguistic input at age 6 months and mental health symptoms at age 18 months"
author: "Lucy King"
output: html_document
---

# Environment
```{r setup, include=FALSE}
# Libraries
library(tidyverse)
library(Hmisc)
library(car)
library(corrr)
library(corrplot)
library(ggpubr)
library(modelr)
library(gvlma)
library(sjstats)
library(glmpath)
library(glmnet)
library(lme4)
library(lmerTest)
library(pwr)
library(directlabels)

# Files 
eligible_id_file <- "~/Desktop/BABIES/lena_symptoms/data_final/eligible_IDs.csv"
fp_intervention_id <- "~/Desktop/BABIES/lena_symptoms/data_final/ID_group_assignment.xlsx"
q_18mo_file <- "~/Desktop/BABIES/lena_symptoms/data_final/q_18month_scores_20190726.csv"
q_18mo_ages_file <- "~/Desktop/BABIES/lena_symptoms/data_final/q_18month_ages.csv"
demographics_file <- "~/Desktop/BABIES/lena_symptoms/data_final/demographics_20190726.csv"
lena_file <- "~/Desktop/BABIES/lena_symptoms/data_final/lena_d1_20191015.csv"
lena_time_file <- "~/Desktop/BABIES/lena_symptoms/data_final/lena_d1_time_20191015.csv"
baby_raceth_file <- "~/Desktop/BABIES/lena_symptoms/data_final/baby_race_ethnicity.csv"
ibq_file <- "~/Desktop/BABIES/lena_symptoms/data_final/ibq_scored_20191105.csv"
sfp_care_file <- "~/Desktop/BABIES/lena_symptoms/data_final/PCIRS_sfp_wf.csv"
fp_care_file <- "~/Desktop/BABIES/lena_symptoms/data_final/free_play_wf_20191014.csv"
cesd_6mo_file <- "~/Desktop/BABIES/lena_symptoms/data_final/cesd_6mo_scored_20191118.csv"
cesd_18mo_file <- "~/Desktop/BABIES/lena_symptoms/data_final/cesd_18mo_scored_20191118.csv"

# Functions
source("identify_outliers_histogram.R")
source("winsorize.R")

theme_lena <-
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 18, hjust = .5),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 16),
    legend.title = element_text(size = 18), 
    legend.text = element_text(size = 16),
    legend.position = "bottom"
  )

# Display options
options(scipen = 999)

d0_d1 %>% 
  count(is.na(cesd18_total), is.na(itsea_symptoms))

d0_d1 %>% 
  filter(is.na(cesd18_total), !is.na(itsea_symptoms)) %>% 
  pull(ID)

```

# Read in and join data
```{r}
d0 <-
  read_csv(eligible_id_file) %>% 
  mutate(ID = as.numeric(ID)) %>% 
  left_join(
    read_csv(demographics_file) %>% 
      dplyr::select(
        ID,
        education,
        annual_income,
        income_needs,
        male,
        baby_age_6mo_visit = baby_age_6mo_vsit,
        mom_age_6mo_visit,
        mom_race,
        mom_ethnicity,
        child_race,
        childrace_describe,
        child_ethnicity
      ),
    by = "ID"
  ) %>% 
  left_join(
    read_csv(fp_care_file) %>% 
      dplyr::select(
        ID,
        sens_fp = sens_fin,
        negmood_fp = negmood_fin
      ),
    by = "ID"
  ) %>% 
  left_join(
    read_csv(sfp_care_file) %>% 
      dplyr::select(
        ID,
        sens_sfp = sens_R_M
      ),
    by = "ID"
  )  %>% 
  left_join(
    read_csv(q_18mo_file) %>% 
      dplyr::select(
        ID, 
        itsea_symptoms,
        # itsea symptoms items
        itsea_a2, 
        itsea_a4, 
        itsea_b8, 
        itsea_b10, 
        itsea_b27, 
        itsea_b32,
        itsea_a28, 
        itsea_a30, 
        itsea_a33, 
        itsea_b3, 
        itsea_b9, 
        itsea_b16, 
        itsea_b30, 
        itsea_b34, 
        itsea_b44, 
        itsea_b88, 
        itsea_c2, 
        itsea_e4,
        itsea_a9, 
        itsea_a39, 
        itsea_a40, 
        itsea_b43, 
        itsea_b76, 
        itsea_b81, 
        itsea_b84, 
        itsea_b91, 
        itsea_b92,
        itsea_a3, 
        itsea_a12, 
        itsea_a35, 
        itsea_b37, 
        itsea_b70, 
        itsea_b86, 
        itsea_e5, 
        itsea_e6, 
        itsea_e11,
        itsea_a7, 
        itsea_a21, 
        itsea_a23, 
        itsea_b31, 
        itsea_b45, 
        itsea_b50, 
        itsea_b53, 
        itsea_b59, 
        itsea_b65, 
        itsea_b66, 
        itsea_b74, 
        itsea_b80, 
        itsea_b85,
        itsea_concern_ied,
        baby_age_18month
      ),
    by = "ID"
  ) %>% 
  left_join(
    read_csv(ibq_file) %>% 
      dplyr::select(
        ID,
        #IBQ NEG items
        ibq_64, ibq_74, ibq_75, ibq_32, ibq_79, ibq_80,
        ibq_2, ibq_3_r, ibq_4, ibq_21, ibq_52, ibq_53, ibq_62,
        ibq_22, ibq_76, ibq_77, ibq_78, ibq_87, ibq_89,
        ibq_36, ibq_37, ibq_38, ibq_63, ibq_71, ibq_72,
        NEG
      ),
    by = "ID"
  ) %>% 
  left_join(
    read_csv(lena_file),
    by = "ID"
  )  %>% 
  mutate(
    day_type = as.factor(day_type),
    male = as.factor(male)
  ) %>% 
  left_join(
    readxl::read_xlsx(fp_intervention_id),
    by = "ID"
  ) %>% 
  left_join(
    read_csv(cesd_6mo_file) %>% 
      rename_at(
        vars(starts_with("cesd")),
        list(~str_replace(., "cesd", "cesd6"))
      ),
    by = "ID"
  ) %>% 
  left_join(
    read_csv(cesd_18mo_file) %>% 
      rename_at(
        vars(starts_with("cesd")),
        list(~str_replace(., "cesd", "cesd18"))
      ),
    by = "ID"
  ) %>% 
  mutate(
    day_type = as.factor(day_type),
    male = as.factor(male),
    mom_ethnicity = as.factor(mom_ethnicity),
    baby_age = if_else(
      is.na(baby_age_lena),
      baby_age_6mo_visit, baby_age_lena
    )
  ) 
```

# Retention / Missing data

Dyads who completed the 6-month assessment (either lab or home observation), were eligible for the 18-month assesment, and complete the 18-month assessment are incldued in the current analyses. 

```{r}
d0_d1 <-
  d0 %>% 
  filter(
    !is.na(itsea_symptoms), baby_age_18month <= 21
  ) 

#missing LENA
d0_d1 %>% 
  count(is.na(ctc_daily_rate))

#missing SFP
d0_d1 %>% 
  count(is.na(sens_sfp))

#missing FP
d0_d1 %>% 
  count(is.na(sens_fp))
```

```{r}
d0_d1 %>% 
  count(!is.na(NEG))

d0_d1 %>% 
  count(!is.na(intervention_group))
```

# Power
```{r}
#adjust p-value based on Holm-Bonferonni method
p.adjust(.0083, method = "holm", n = 6)

pwr.f2.test(u = 1, v = 69, f2 = .20, sig.level = .008)
```

# Descriptive statistics 

## IBQ, ITSEA, CESD reliability

```{r}
d0_d1 %>% 
  select(ibq_64:ibq_72) %>% 
  alpha(check.keys = TRUE)
```

```{r}
d0_d1 %>% 
  select(itsea_a2:itsea_b85, -itsea_c2) %>% 
  alpha()
```

```{r}
d0_d1 %>% 
  select(
    cesd6_1,
    cesd6_2,
    cesd6_3,
    cesd6_4_r,
    cesd6_5,
    cesd6_6,
    cesd6_7,
    cesd6_8_r,
    cesd6_9,
    cesd6_10,
    cesd6_11,
    cesd6_12_r,
    cesd6_13,
    cesd6_14,
    cesd6_15,
    cesd6_16_r,
    cesd6_17,
    cesd6_18,
    cesd6_19,
    cesd6_20
  ) %>% 
  alpha()
```

```{r}
d0_d1 %>% 
  select(
    cesd18_1,
    cesd18_2,
    cesd18_3,
    cesd18_4_r,
    cesd18_5,
    cesd18_6,
    cesd18_7,
    cesd18_8_r,
    cesd18_9,
    cesd18_10,
    cesd18_11,
    cesd18_12_r,
    cesd18_13,
    cesd18_14,
    cesd18_15,
    cesd18_16_r,
    cesd18_17,
    cesd18_18,
    cesd18_19,
    cesd18_20
  ) %>% 
  alpha()
```

```{r}
d0_d1 %>% 
  summarize_at(
    vars(
      baby_age_18month,
      baby_age_lena,
      NEG,
      cvc_max,
      ctc_daily_rate,
      ctc_prop,
      awc_daily_rate,
      awc_prop,
      sens_sfp,
      sens_fp,
      negmood_fp,
      itsea_symptoms,
      duration,
      mom_age_6mo_visit,
      income_needs,
      percent_mother,
      cesd6_total,
      cesd18_total
    ), 
    funs(mean, sd, min, max), na.rm = TRUE)
```
range preg weeks gestation: 16.71 - 34.71428571

Race:
1, American Indian or Alaska Native
2, Asian
3, Black or African American
4, Native Hawaiian or Other Pacific Islander
5, White
6, Other

Education:
0, No schooling completed
2, Nursery school to 8th grade
3, Some high school, no diploma
4, High school graduate, diploma or the equivalent (i.e. GED)
5, Some college credit, no degree
6, Trade/technical/vocational training
7, Associate degree
8, Bachelor's degree
9, Graduate degree
10, Other

Income:
1, $0-5,000
2, $5,001-15,000
3, $15,001-30,000
4, $30,001-60,000
5, $60,001-90,000
6, $90,001-150,000
7, Greater than $150,000
```{r}
d0_d1 %>% 
  count(male) %>% 
  mutate(
    per = n / sum(n)
  )

d0_d1 %>% 
  filter(!is.na(duration)) %>% 
  count(duration >= 12) %>% 
  mutate(
    per = n / sum(n)
  )

d0_d1 %>% 
  count(itsea_concern_ied) %>% 
  mutate(
    per = n / sum(n)
  )

d0_d1 %>% 
  count(income_needs < 1) %>% 
  mutate(
    per = n / sum(n)
  )

d0_d1 %>% 
  count(mom_ethnicity) %>% 
  mutate(
    per = n / sum(n)
  )

d0_d1 %>% 
  count(mom_race) %>% 
  mutate(
    per = n / sum(n)
  ) %>% 
  arrange(desc(n))

d0_d1 %>% 
  count(education) %>% 
  mutate(
    per = n / sum(n)
  ) %>% 
  arrange(education)

d0_d1 %>% 
  count(day_type) %>% 
  mutate(per = n / sum(n))

d0_d1 %>% 
  count(cesd6_total >= 16) %>% 
  mutate(per = n / sum(n))

d0_d1 %>% 
  count(cesd18_total >= 16) %>% 
  mutate(per = n / sum(n))
```


## Distributions 

```{r}
d0_d1 %>% 
  identify_outliers_hist(x = ctc_daily_rate)

d0_d1 %>% 
  identify_outliers_hist(x = ctc_prop)

d0_d1 %>% 
  identify_outliers_hist(x = awc_daily_rate)

d0_d1 %>% 
  identify_outliers_hist(x = awc_prop)

d0_d1 %>% 
  identify_outliers_hist(x = sens_sfp)

d0_d1 %>% 
  identify_outliers_hist(x = sens_fp)

d0_d1 %>% 
  identify_outliers_hist(x = itsea_symptoms)

d0_d1 %>% 
  identify_outliers_hist(x = cesd6_total)

d0_d1 %>% 
  identify_outliers_hist(x = cesd18_total)

d0_d1 %>% 
  count(is.na(sens_fp))
```


## Correlations
```{r}
correlation_table <- 
  d0_d1 %>% 
  dplyr::select(
    duration, 
    cvc_max,
    ctc_daily_rate,
    ctc_prop,
    awc_daily_rate,
    awc_prop,
    sens_sfp,
    sens_fp,
    itsea_symptoms,
    cesd6_total,
    cesd18_total
  ) %>% 
  correlate() %>% 
  fashion()

write_csv(
   correlation_table,
   "~/Desktop/BABIES/lena_symptoms/manuscript/correlation_table_20191015.csv"
 )

cor.test(d0_d1$income_needs, d0_d1$duration)
cor.test(d0_d1$NEG, d0_d1$itsea_symptoms)

cor.test(d0_d1$sens_sfp, d0_d1$itsea_symptoms)
cor.test(d0_d1$sens_sfp, d0_d1$ctc_prop)
cor.test(d0_d1$sens_sfp, d0_d1$ctc_daily_rate)
cor.test(d0_d1$sens_fp, d0_d1$awc_daily_rate)
cor.test(d0_d1$sens_sfp, d0_d1$awc_daily_rate)
cor.test(d0_d1$sens_sfp, d0_d1$awc_prop)
cor.test(d0_d1$sens_fp, d0_d1$sens_sfp)

cor.test(d0_d1$awc_daily_rate, d0_d1$awc_prop)
cor.test(d0_d1$awc_daily_rate, d0_d1$ctc_daily_rate)
cor.test(d0_d1$awc_daily_rate, d0_d1$ctc_prop)
cor.test(d0_d1$awc_prop, d0_d1$ctc_daily_rate)
cor.test(d0_d1$awc_prop, d0_d1$ctc_prop)
cor.test(d0_d1$ctc_daily_rate, d0_d1$ctc_prop)
cor.test(d0_d1$ctc_daily_rate, d0_d1$cvc_max)

cor.test(d0_d1$income_needs, d0_d1$ctc_prop)
cor.test(d0_d1$income_needs, d0_d1$ctc_daily_rate)
cor.test(d0_d1$income_needs, d0_d1$awc_prop)
cor.test(d0_d1$income_needs, d0_d1$awc_daily_rate)
cor.test(d0_d1$income_needs, d0_d1$sens_sfp)
cor.test(d0_d1$income_needs, d0_d1$sens_fp)

cor.test(d0_d1$education, d0_d1$awc_daily_rate, method = "spearman")
cor.test(d0_d1$education, d0_d1$ctc_daily_rate, method = "spearman")
cor.test(d0_d1$education, d0_d1$awc_prop, method = "spearman")
cor.test(d0_d1$education, d0_d1$ctc_prop, method = "spearman")
cor.test(d0_d1$education, d0_d1$sens_sfp, method = "spearman")
cor.test(d0_d1$education, d0_d1$sens_fp, method = "spearman")

cor.test(d0_d1$education, d0_d1$itsea_symptoms, method = "spearman")
cor.test(d0_d1$education, d0_d1$NEG, method = "spearman")

cor.test(d0_d1$cesd6_total, d0_d1$itsea_symptoms)
cor.test(d0_d1$cesd18_total, d0_d1$itsea_symptoms)
cor.test(d0_d1$cesd6_total, d0_d1$awc_daily_rate)
```

```{r}
correlation_table_ses <- 
  d0_d1 %>% 
  dplyr::select(
    income_needs,
    education,
    ctc_daily_rate,
    ctc_prop,
    awc_daily_rate,
    awc_prop,
    sens_sfp,
    sens_fp,
    itsea_symptoms
  ) %>% 
  correlate() %>% 
  fashion()
```

## t-tests by day type

```{r}
t.test(d0_d1$awc_daily_rate ~ d0_d1$day_type)

t.test(d0_d1$ctc_daily_rate ~ d0_d1$day_type)

t.test(d0_d1$awc_prop ~ d0_d1$day_type)

t.test(d0_d1$ctc_prop ~ d0_d1$day_type)
```

## t-tests by race and ethnicity

```{r}
d0_d1 <-
  d0_d1 %>% 
  mutate(
    white = as.factor(
      if_else(
        mom_race == 5, 
        1, 0
      )
    )
  )

# white vs. non-white
t.test(d0_d1$itsea_symptoms ~ d0_d1$white)
t.test(d0_d1$ctc_daily_rate ~ d0_d1$white)
t.test(d0_d1$ctc_prop ~ d0_d1$white)
t.test(d0_d1$awc_daily_rate ~ d0_d1$white)
t.test(d0_d1$awc_prop ~ d0_d1$white)
t.test(d0_d1$sens_fp ~ d0_d1$white)
t.test(d0_d1$sens_sfp ~ d0_d1$white)


# latina vs. non-Latina
t.test(d0_d1$itsea_symptoms ~ d0_d1$mom_ethnicity)
t.test(d0_d1$ctc_daily_rate ~ d0_d1$mom_ethnicity)
t.test(d0_d1$ctc_prop ~ d0_d1$mom_ethnicity)
t.test(d0_d1$awc_daily_rate ~ d0_d1$mom_ethnicity)
t.test(d0_d1$awc_prop ~ d0_d1$mom_ethnicity)
t.test(d0_d1$sens_fp ~ d0_d1$mom_ethnicity)
t.test(d0_d1$sens_sfp ~ d0_d1$mom_ethnicity)
```
## Histograms
```{r}
d0_d1 %>% 
  select(
    ctc_daily_rate,
    awc_daily_rate,
    ctc_prop,
    awc_prop,
    sens_fp,
    sens_sfp
  ) %>% 
  gather(measure, value, ctc_daily_rate:sens_sfp) %>% 
  mutate(
    measure = factor(
      measure,
      levels = c(
        "awc_prop",
        "ctc_prop",
        "awc_daily_rate",
        "ctc_daily_rate",
        "sens_sfp",
        "sens_fp"
      ),
      labels = c(
        "AW consistency", 
        "CT consistency", 
        "AW quantity", 
        "CT quantity",
        "Sensitivity to distress",
        "Sensivity during play"
        )
    )
  ) %>% 
  ggplot(aes(value)) +
  geom_histogram() +
  facet_wrap(.~measure, scales = "free", ncol = 2, nrow = 3) +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 18),
    panel.grid = element_blank(),
    plot.title = element_text(size = 18, hjust = .5),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 16),
    legend.position = "none"
  ) +
  labs(
    x = "Caregiving input value"
  )


ggsave(
  "~/Desktop/BABIES/lena_symptoms/manuscript/care_hist_ggpanels.png",
  width = 7.5,
  height = 8
)
```

```{r}
d0_d1 %>% 
  ggplot(aes(itsea_symptoms)) +
  geom_histogram() +
  scale_x_continuous(breaks = seq.int(0, 3, .25)) +
  theme_lena +
  labs(
    x = "Toddler symptoms of psychopathology"
  )

ggsave(
  "~/Desktop/BABIES/lena_symptoms/manuscript/itsea_hist.png"
)
```


```{r}
d0_d1 %>% 
  ggplot(aes(cesd6_total)) +
  geom_histogram() +
  scale_x_continuous(breaks = seq.int(0, 3, .25)) +
  theme_lena +
  labs(
    x = "Maternal depressive symptoms\n at infant age 6 months"
  )

ggsave(
  "~/Desktop/BABIES/lena_symptoms/manuscript/cesd6_hist.png"
)
```

```{r}
d0_d1 %>% 
  ggplot(aes(cesd18_total)) +
  geom_histogram() +
  scale_x_continuous(breaks = seq.int(0, 3, .25)) +
  theme_lena +
  labs(
    x = "Maternal depressive symptoms\n at infant age 18 months"
  )

ggsave(
  "~/Desktop/BABIES/lena_symptoms/manuscript/cesd18_hist.png"
)
```

# Results 

## Associations of LENA measures with ITSEA symptoms 

### Effect code categorical variables

```{r}
contrasts(d0_d1$male) <- c(-1, 1)
contrasts(d0_d1$white) <- c(-1, 1)
contrasts(d0_d1$mom_ethnicity) <- c(-1, 1)
```

### Formal model fitting 
```{r}
symp <-
  lm(
    itsea_symptoms ~ 1,
    data = d0_d1
  )
```

```{r}
d0_d1_lena <-
  d0_d1 %>% 
  filter(!is.na(cvc_max))

symp_lena <-
  lm(
    itsea_symptoms ~ 1,
    data = d0_d1_lena
  )

symp_cvc <-
  lm(
    itsea_symptoms ~
      scale(cvc_max, scale = FALSE),
    data = d0_d1_lena
  )

anova(symp_lena, symp_cvc)
```

```{r}
# mom age at lena
symp_momage <-
  lm(
    itsea_symptoms ~ 
      scale(mom_age_6mo_visit, scale = FALSE),
    data = d0_d1
  )
anova(symp, symp_momage)
```

```{r}
# baby age at lena
symp_babyage <-
  lm(
    itsea_symptoms ~ 
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(baby_age, scale = FALSE),
    data = d0_d1
  )
summary(symp_babyage)
anova(symp_momage, symp_babyage)
```

```{r}
# sex
symp_sex <-
  lm(
    itsea_symptoms ~ 
      scale(mom_age_6mo_visit, scale = FALSE) +
      male,
    data = d0_d1
  )
anova(symp_momage, symp_sex)
```

```{r}
# negative affectivity
d0_d1_temperament <- 
  d0_d1 %>% 
  filter(!is.na(NEG))

symp_momage_NEG <-
  lm(
    itsea_symptoms ~ 
      scale(mom_age_6mo_visit, scale = FALSE),
    data = d0_d1_temperament
  )

symp_NEG <-
  lm(
    itsea_symptoms ~ 
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(NEG, scale = FALSE),
    data = d0_d1_temperament
  )

anova(symp_momage_NEG, symp_NEG)
```

```{r}
#income-to-needs 
d0_d1_inr <- 
  d0_d1 %>% 
  filter(!is.na(income_needs))

symp_momage_NEG_inr <-
  lm(
    itsea_symptoms ~ 
    scale(mom_age_6mo_visit, scale = FALSE) +
    scale(NEG, scale = FALSE),
    data = d0_d1_inr
  )

symp_inr <-
  lm(
    itsea_symptoms ~ 
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(NEG, scale = FALSE) +
      scale(income_needs, scale = FALSE),
    data = d0_d1_inr
  )

anova(symp_momage_NEG_inr, symp_inr)
```

```{r}
#education
d0_d1_educ <- 
  d0_d1 %>% 
  filter(!is.na(education))

symp_momage_NEG_educ <-
  lm(
    itsea_symptoms ~ 
    scale(mom_age_6mo_visit, scale = FALSE) +
    scale(NEG, scale = FALSE),
    data = d0_d1_educ
  )

symp_educ <-
  lm(
    itsea_symptoms ~ 
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(NEG, scale = FALSE) +
      scale(education, scale = FALSE),
    data = d0_d1_educ
  )

anova(symp_momage_NEG_educ, symp_educ)
```

```{r}
# Hispanic ethnicity
d0_d1_ethnicity <- 
  d0_d1 %>% 
  filter(!is.na(mom_ethnicity))

symp_momage_NEG_ethn <-
  lm(
    itsea_symptoms ~ 
    scale(mom_age_6mo_visit, scale = FALSE) +
    scale(NEG, scale = FALSE),
    data = d0_d1_ethnicity
  )

symp_ethn <-
  lm(
    itsea_symptoms ~ 
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(NEG, scale = FALSE) +
      mom_ethnicity,
    data = d0_d1_ethnicity
  )

anova(symp_momage_NEG_ethn, symp_ethn)
```

```{r}
# White vs. not White 
d0_d1_race <- 
  d0_d1 %>% 
  filter(!is.na(white))

symp_momage_NEG_race <-
  lm(
    itsea_symptoms ~ 
    scale(mom_age_6mo_visit, scale = FALSE) +
    scale(NEG, scale = FALSE),
    data = d0_d1_race
  )

symp_race <-
  lm(
    itsea_symptoms ~ 
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(NEG, scale = FALSE) +
      white,
    data = d0_d1_race
  )

anova(symp_momage_NEG_race, symp_race)
```

```{r}
# maternal 6-month depressive symptoms
symp_cesd6 <-
  lm(
    itsea_symptoms ~ 
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(NEG, scale = FALSE) +
      scale(cesd6_total, scale = FALSE),
    data = d0_d1_temperament
  )

anova(symp_NEG, symp_cesd6)
```

```{r}
# maternal 18-month depressive symptoms
symp_cesd18 <-
  lm(
    itsea_symptoms ~ 
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(NEG, scale = FALSE) +
      scale(cesd18_total, scale = FALSE), 
    data = d0_d1
  )
anova(symp_NEG, symp_cesd18)
```

```{r}
final_base_model <- 
  lm(
    itsea_symptoms ~ 
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(NEG, scale = FALSE) +
      scale(cesd18_total, scale = FALSE),
    data = d0_d1 
  )
summary(final_base_model)

r.squared_base <- summary(final_base_model)$adj.r.squared

#save residuals
d0_d1 <-
  d0_d1 %>% 
  add_residuals(final_base_model, "resid_symp")
```

### Main effect of AWC consistency

```{r}
sym_awc_prop <- 
  lm(
    itsea_symptoms ~ 
      scale(awc_prop, scale = FALSE) +
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(cesd18_total, scale = FALSE) +
      scale(NEG, scale = FALSE),
    data = d0_d1 
  )
summary(sym_awc_prop)

std_beta(sym_awc_prop)

r_chg_awcprop <- summary(sym_awc_prop)$adj.r.squared - r.squared_base

r_chg_awcprop

confint(sym_awc_prop)

```

```{r}
#assessing outliers
outlierTest(sym_awc_prop) # Bonferonni p-value for most extreme obs
qqPlot(sym_awc_prop, main = "QQ Plot") #qq plot for studentized resid 

# Evaluate Collinearity
vif(sym_awc_prop) # variance inflation factors 

# Global test of model assumptions
gvlma(sym_awc_prop) 
```

```{r}
sym_awc_prop_sqrt <- 
  lm(
    sqrt(itsea_symptoms) ~ 
      scale(awc_prop, scale = FALSE) +
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(cesd18_total, scale = FALSE) +
      scale(NEG, scale = FALSE),
    data = d0_d1 
  )
summary(sym_awc_prop_sqrt)

gvlma(sym_awc_prop_sqrt) 
```

```{r}
d0_d1 %>% 
  ggplot(aes(awc_prop, resid_symp)) +
  geom_point(size = 4, alpha = 1/2) +
  geom_smooth(method = "lm", size = 3, se = FALSE, color = "black") +
  scale_x_continuous(breaks = seq.int(0, 1, .1)) +
  labs(
    x = "Consistency of adult words during infancy",
    y = "Toddler symptoms of psychopathology\n(residuals)"
  ) +
  theme_lena

ggsave(
  "~/Desktop/BABIES/lena_symptoms/manuscript/awc_prop_symptoms.png",
  width = 7,
  height = 5
)
```

### Main effect of CT consistency

```{r}
sym_ctc_prop <- 
  lm(
    itsea_symptoms ~ 
      scale(ctc_prop, scale = FALSE) +
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(cesd18_total, scale = FALSE) +
      scale(NEG, scale = FALSE),
    data = d0_d1 
  )
summary(sym_ctc_prop)

std_beta(sym_ctc_prop)

r_chg_ctcprop <- summary(sym_ctc_prop)$adj.r.squared - r.squared_base

r_chg_ctcprop

confint(sym_ctc_prop)

```

```{r}
#assessing outliers
outlierTest(sym_ctc_prop) # Bonferonni p-value for most extreme obs
qqPlot(sym_ctc_prop, main = "QQ Plot") #qq plot for studentized resid 

# Evaluate Collinearity
vif(sym_ctc_prop) # variance inflation factors 

# Global test of model assumptions
gvlma(sym_ctc_prop) 
```

```{r}
sym_ctc_prop_sqrt <- 
  lm(
    sqrt(itsea_symptoms) ~ 
      scale(ctc_prop, scale = FALSE) +
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(cesd18_total, scale = FALSE) +
      scale(NEG, scale = FALSE),
    data = d0_d1 
  )
summary(sym_ctc_prop_sqrt)

gvlma(sym_ctc_prop_sqrt) 
```


```{r}
d0_d1 %>% 
  ggplot(aes(ctc_prop, resid_symp)) +
  geom_point(alpha = 1/2, size = 4) +
  geom_smooth(method = "lm", size = 3, se = FALSE, color = "black") +
  scale_x_continuous(breaks = seq.int(0, 1, .1)) +
  labs(
    x = "Consistency of conversational turns during infancy",
    y = "Toddler symptoms of psychopathology\n(residuals)"
  ) +
  theme_lena

ggsave(
  "~/Desktop/BABIES/lena_symptoms/manuscript/ctc_prop_symptoms.png",
  width = 7,
  height = 5
)
```

### Main effect of AWC rate

```{r}
sym_awc_rate <- 
  lm(
    itsea_symptoms ~ 
      scale(awc_daily_rate, scale = FALSE) +
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(cesd18_total, scale = FALSE) +
      scale(NEG, scale = FALSE),
    data = d0_d1 
  )
summary(sym_awc_rate)

std_beta(sym_awc_rate)

r_chg_awcrate <- summary(sym_awc_rate)$adj.r.squared - r.squared_base

r_chg_awcrate

confint(sym_awc_rate)
```

```{r}
#assessing outliers
outlierTest(sym_awc_rate) # Bonferonni p-value for most extreme obs
qqPlot(sym_awc_rate, main = "QQ Plot") #qq plot for studentized resid 

# Evaluate Collinearity
vif(sym_awc_rate) # variance inflation factors 

# Global test of model assumptions
gvlma(sym_awc_rate) 
```

```{r}
sym_awc_rate_sqrt <- 
  lm(
    sqrt(itsea_symptoms) ~ 
      scale(awc_daily_rate, scale = FALSE) +
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(cesd18_total, scale = FALSE) +
      scale(NEG, scale = FALSE),
    data = d0_d1 
  )
summary(sym_awc_rate_sqrt)

gvlma(sym_awc_rate_sqrt) 
```

```{r}
d0_d1 %>% 
  ggplot(aes(awc_daily_rate, resid_symp)) +
  geom_point(size = 4) +
  geom_smooth(method = "lm", size = 3, se = FALSE) +
  scale_x_continuous(breaks = seq.int(300, 2500, 300)) +
  labs(
    x = "Adults words per hour during infancy",
    y = "Toddler symptoms of psychopathology\n(residuals)"
  ) +
  theme_lena

ggsave(
  "~/Desktop/BABIES/lena_symptoms/manuscript/awc_rate_symptoms.png",
  width = 7,
  height = 5
)
```


### Main effect of CTC rate

```{r}
sym_ctc_rate <- 
  lm(
    itsea_symptoms ~ 
      scale(ctc_daily_rate, scale = FALSE) + 
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(cesd18_total, scale = FALSE) +
      scale(NEG, scale = FALSE),
    data = d0_d1 
  )
summary(sym_ctc_rate)

std_beta(sym_ctc_rate)

r_chg_ctcrate <- summary(sym_ctc_rate)$adj.r.squared - r.squared_base

r_chg_ctcrate

confint(sym_ctc_rate)
```

```{r}
#assessing outliers
outlierTest(sym_ctc_rate) # Bonferonni p-value for most extreme obs
qqPlot(sym_ctc_rate, main = "QQ Plot") #qq plot for studentized resid 

# Evaluate Collinearity
vif(sym_ctc_rate) # variance inflation factors 

# Global test of model assumptions
gvlma(sym_ctc_rate) 
```


```{r}
sym_ctc_rate_sqrt <- 
  lm(
    sqrt(itsea_symptoms) ~ 
      scale(ctc_daily_rate, scale = FALSE) +
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(cesd18_total, scale = FALSE) +
      scale(NEG, scale = FALSE),
    data = d0_d1 
  )
summary(sym_ctc_rate_sqrt)

gvlma(sym_ctc_rate_sqrt) 
```

```{r}
d0_d1 %>% 
  ggplot(aes(ctc_daily_rate, resid_symp)) +
  geom_point(size = 4) +
  geom_smooth(method = "lm", size = 3, se = FALSE) +
  scale_x_continuous(breaks = seq.int(0, 60, 10)) +
  labs(
    x = "Conversational turns per hour during infancy",
    y = "Toddler symptoms of psychopathology\n(residuals)"
  ) +
  theme_lena

ggsave(
  "~/Desktop/BABIES/lena_symptoms/manuscript/ctc_rate_symptoms.png",
  width = 7,
  height = 5
)
  
```


# Effects of laboratory caregiving on ITSEA symptoms

## Sensitivity during play
```{r}
sym_fp <-
  lm(
    itsea_symptoms ~ 
      scale(sens_fp, scale = FALSE) +
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(cesd18_total, scale = FALSE) +
      scale(NEG, scale = FALSE),
    data = d0_d1 
  )
summary(sym_fp)

std_beta(sym_fp)

r_chg_fp <- summary(sym_fp)$adj.r.squared - r.squared_base

r_chg_fp

confint(sym_fp)
``` 

```{r}
#assessing outliers
outlierTest(sym_fp) # Bonferonni p-value for most extreme obs
qqPlot(sym_fp, main = "QQ Plot") #qq plot for studentized resid 

# Evaluate Collinearity
vif(sym_fp) # variance inflation factors 

# Global test of model assumptions
gvlma(sym_fp) 
```

```{r}
d0_d1_fp <-
  d0_d1 %>% 
  slice(1:4, 6:105)

sym_fp_sqrt <- 
  lm(
    sqrt(itsea_symptoms) ~ 
      scale(sens_fp, scale = FALSE) +
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(cesd18_total, scale = FALSE) +
      scale(NEG, scale = FALSE),
    data = d0_d1 
  )
summary(sym_fp_sqrt)

gvlma(sym_fp_sqrt) 
```

```{r}
d0_d1 %>% 
  ggplot(aes(sens_fp, resid_symp)) +
  geom_point(size = 4) +
  geom_smooth(method = "lm", size = 3, se = FALSE, color = "red") +
  scale_x_continuous(breaks = seq.int(1, 7, .5)) +
  labs(
    x = "Maternal sensitivity during play",
    y = "Toddler symptoms of psychopathology\n(residuals)"
  ) +
  theme_lena

ggsave(
  "~/Desktop/BABIES/lena_symptoms/manuscript/sens_fp_symptoms.png",
  width = 7,
  height = 5
)
```

## Sensitivity to distress
```{r}
sym_sfp <-
  lm(
    itsea_symptoms ~ 
      scale(sens_sfp, scale = FALSE) +
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(cesd18_total, scale = FALSE) +
      scale(NEG, scale = FALSE),
    data = d0_d1 
  )
summary(sym_sfp)

std_beta(sym_sfp)

r_chg_sfp <- summary(sym_sfp)$adj.r.squared - r.squared_base

r_chg_sfp

confint(sym_sfp)
```

```{r}
#assessing outliers
outlierTest(sym_sfp) # Bonferonni p-value for most extreme obs
qqPlot(sym_sfp, main = "QQ Plot") #qq plot for studentized resid 

# Evaluate Collinearity
vif(sym_sfp) # variance inflation factors 

# Global test of model assumptions
gvlma(sym_sfp) 
```

```{r}
sym_sfp_sqrt <- 
  lm(
    sqrt(itsea_symptoms) ~ 
      scale(sens_sfp, scale = FALSE) +
      scale(mom_age_6mo_visit, scale = FALSE) +
      scale(NEG, scale = FALSE),
    data = d0_d1 
  )
summary(sym_sfp_sqrt)

gvlma(sym_sfp_sqrt) 
```

```{r}
d0_d1 %>% 
  ggplot(aes(sens_sfp, resid_symp)) +
  geom_point(size = 4) +
  geom_smooth(method = "lm", size = 3, se = FALSE, color = "red") +
  scale_x_continuous(breaks = seq.int(1, 7, .5)) +
  labs(
    x = "Maternal sensitivity to distress",
    y = "Toddler symptoms of psychopathology\n(residuals)"
  ) +
  theme_lena

ggsave(
  "~/Desktop/BABIES/lena_symptoms/manuscript/sens_sfp_symptoms.png",
  width = 7,
  height = 5
)
```

# Plot all caregiving measures in panels
```{r}
d0_d1 %>% 
  select(
    ctc_daily_rate,
    ctc_prop,
    awc_daily_rate,
    awc_prop,
    sens_sfp,
    sens_fp,
    resid_symp
  ) %>% 
  gather(measure, value, ctc_daily_rate:sens_fp) %>% 
  mutate(
    measure = factor(
      measure,
      levels = c(
        "awc_prop",
        "ctc_prop",
        "awc_daily_rate",
        "ctc_daily_rate",
        "sens_sfp",
        "sens_fp"
      ),
      labels = c(
        "AW consistency", 
        "CT consistency", 
        "AW quantity", 
        "CT quantity",
        "Sensitivity to distress",
        "Sensitivity during play"
        )
    )
  ) %>% 
  ggplot(aes(value, resid_symp)) +
  geom_point(size = 3, alpha = 1/2) +
  geom_smooth(method = "lm", size = 2) +
  facet_wrap(.~measure, scales = "free", ncol = 2, nrow = 3) +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 17),
    panel.grid = element_blank(),
    plot.title = element_text(size = 18, hjust = .5),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 16),
    legend.position = "none"
  ) +
  labs(
    x = "Caregiving input value",
    y = "Toddler symptoms of psychopathology\n(residuals)"
  )


ggsave(
  "~/Desktop/BABIES/lena_symptoms/manuscript/care_ggpanels.png",
  width = 7,
  height = 8
)
```


##Regularized regression
We have observations on n units of a DV and p predictors, where p >> n.  (In typical regressions, n ≈ 10*p > p.)  In principle, using any n of the p predictors allows us to ‘predict’ the n DV values perfectly.  However, prediction of new observations is likely to be ‘poor’.  This problem is ill-conditioned.  The data set (or system) is said to be over-determined.

Regularization resolves non-complementary goals of wanting to drive down the sum of squared errors in the model for the observed data but also wanting your model to predict new data (avoding overfitting).

The elastic net (Zou & Hastie, 2005) was designed to achieve the sparseness of the LASSO, and the ability of ridge regression to select correlated features. The penalty used is a weighted average of penalties on the L1-norm and the L2-norm. This model can be rewritten as a type of LASSO and, therefore, can be estimated with the efficiency of the LASSO. Basically you are getting sparseness without losing important information. It is like a stretchable fishing net that retains ‘all the big fish’.

Choosing the value of λ under the L1-norm, which results in some bi  = 0, is like choosing which predictors to include in a stepwise regression.The optimal λ (penalty on complexity) is the value at which the CV error / AIC/ BIC / deviance of the optimal model is a minimum. 

```{r}
d0_rr <-
  d0_d1 %>% 
  select(
    resid_symp,
    ctc_daily_rate,
    awc_daily_rate,
    ctc_prop,
    awc_prop,
    sens_fp,
    sens_sfp
  ) %>% 
  na.omit()
```

```{r}
z_score <- function(x) {
  diff_mu <- x - mean(x, na.rm = T)
  sd <- sd(x, na.rm = T)
  diff_mu / sd
}

predictors <- scale(d0_rr[2:7], scale = TRUE)

symptoms <- z_score(d0_rr$resid_symp)
```

Running both glmnet and glmpath and making sure results are the same. 

```{r}
fit_net <- glmnet(predictors, symptoms, family = "gaussian")
fit_path <- glmpath(predictors, symptoms, family = "gaussian")
```

As lambda decreases, df(n of non-zero coeffs) increase; %Dev is like R2. Step 1 is when all coeffs are held to 0. 

```{r}
print(fit_path)
summary(fit_path)
plot(fit_path)
plot(fit_net, label = TRUE)
```

### Fit cross-validation model to determine optimal lambda


Note also that the results of cv.glmnet are random, since the folds are selected at random. Users can reduce this randomness by running cv.glmnet many times, and averaging the error curves.

#### CV with alpha = .5
```{r inc_cv}
set.seed(123)

lambdaMins <- c()
lambda1SEs <- c()

for (i in 1:1000) {
  fit_rr_cv <- cv.glmnet(predictors, symptoms, alpha = .5, family = "gaussian")
  lambdaMins <- cbind(lambdaMins, fit_rr_cv$lambda.min)
  lambda1SEs <- cbind(lambda1SEs, fit_rr_cv$lambda.1se)
}

```

```{r}
plot.cv.glmnet(fit_rr_cv)
```

#### Gather lambda values from CV 
```{r}
lambdaMins <- as_tibble(lambdaMins)
lambdaMins <-
  lambdaMins %>%
  gather(run, lambdaMin, V1:V1000) 


lambda1SEs <- as.tibble(lambda1SEs)
lambda1SEs <-
  lambda1SEs %>%
  gather(run, lambda1SE, V1:V1000) 

lambdas <- merge(lambdaMins, lambda1SEs, by = "run")
```

#### Summarise results of cross-validation 
```{r}
lambdas %>%
  ggplot(mapping = aes(x = "", y = lambdaMin)) +
  geom_boxplot() +
  coord_flip() +
  labs(
    x = ""
  )

lambdas %>%
  ggplot(mapping = aes(x = "", y = lambda1SE)) +
  geom_boxplot() +
  coord_flip() +
  labs(
    x = ""
  )

lambdas_summary <-
  lambdas %>%
  summarise(
    min_mean = mean(lambdaMin),
    min_median = median(lambdaMin),
    min_sd = sd(lambdaMin),
    SE_mean = mean(lambda1SE),
    SE_median = median(lambda1SE),
    SE_sd = sd(lambda1SE)
  )
lambdas_summary

range(lambdas$lambdaMin)
range(lambdas$lambda1SE)
```

### Print coeffs and plots for optimal lambda model
```{r}
coef(fit_net, s = lambdas_summary$min_median)
```

### Visualize EN
```{r}
d_predictor <- 
  fit_path$b.predictor %>% # extract the coefficient estimates
  data.frame() %>% # turn them into a dataframe
  rownames_to_column(var = "step") %>% # add the rownames as a "step" variable
  mutate(
    lambda = fit_path$lambda, # add the lambda values for each step
    aic = fit_path$aic, # add AIC for each step
    bic = fit_path$bic,
    deviance = fit_path$deviance
  ) %>% # add BIC for each step
  rename(
    `AW quantity` = awc_daily_rate, 
    `CT quantity` = ctc_daily_rate,
    `CT consistency` = ctc_prop,
    `AW consistency` = awc_prop,
    `Play sensitivity` = sens_fp,
    `Distress sensitivity` = sens_sfp
  ) %>% 
  gather(predictor, coeff, `CT quantity`:`Distress sensitivity`) %>% # turn into longform 
  arrange(step, predictor) # arrange by step number and selfrating



ggplot(data = d_predictor, aes(x = lambda, y = coeff, color = predictor, fill = predictor)) +
  geom_point() +
  geom_smooth(method = "loess", se = FALSE, size = .5) +
  theme_bw() +
  theme(
    text = element_text(size = 20),
    legend.position = "none"
  ) + 
  geom_dl(aes(label = predictor), method = list("first.qp", cex = 1)) +
  xlim(-5, max(d_predictor$lambda)) +
  ylim(-.3, .2)

ggsave(
  "~/Desktop/BABIES/lena_symptoms/manuscript/en_lambda.png",
  width = 7,
  height = 5
  )

ggplot(data = d_predictor, aes(x = deviance, y = coeff, color = predictor)) +
  geom_point() +
  geom_line() +
  theme_bw() +
  theme(
    text = element_text(size = 21),
    legend.position = "none"
  ) + 
  geom_dl(aes(label = predictor), method = list("first.qp", cex = 1)) +
  xlim(45, max(d_predictor$deviance)) +
  ylim(-.3, .2)

ggsave(
  "~/Desktop/BABIES/lena_symptoms/manuscript/en_deviance.png",
  width = 7,
  height = 5
  )
```


## Who is talking?

```{r}
d0_d1 %>% 
  count(lena_day_1_followup_questions_complete == 2)
```
```{r}
d0_d1_follow <-
  d0_d1 %>% 
  filter(
    lena_day_1_followup_questions_complete == 2,
    lena_caregivers___1 != 0 |
      lena_caregivers___2 != 0 |
      lena_caregivers___3 != 0 |
      lena_caregivers___4 != 0 |
      lena_caregivers___5 != 0 |
      lena_caregivers___6 != 0 |
      lena_caregivers___7 != 0 |
      lena_caregivers___8 != 0 |
      lena_caregivers___9 != 0 |
      lena_caregivers___10 != 0
  ) %>% 
  rename(
    mom_present = lena_caregivers___1,
    dad_present = lena_caregivers___2,
    daycare_present = lena_caregivers___3,
    nanny_present = lena_caregivers___4,
    sibling_present = lena_caregivers___5,
    cousin_present = lena_caregivers___6,
    grandparent_present = lena_caregivers___7,
    friends_present = lena_caregivers___8,
    relative_present = lena_caregivers___9, #any other relative
    other_present = lena_caregivers___10
  )
```

```{r}
d0_d1_follow %>% 
  count(!is.na(percent_mother))

d0_d1_follow %>%
  summarise_at(
    vars(percent_mother),
    funs(mean, sd, min, max), na.rm = TRUE
  )

d0_d1_follow %>% 
  ggplot(aes(percent_mother, ctc_prop)) +
  geom_point() +
  geom_smooth(method = "lm")

cor.test(d0_d1_follow$percent_mother, d0_d1_follow$ctc_prop, method = "pearson")
```

```{r}
d0_d1_follow %>%
  count(mom_present) %>% 
  mutate(
    per = n / sum(n)
  )

d0_d1_follow %>%
  count(dad_present) %>% 
  mutate(
    per = n / sum(n)
  )

d0_d1_follow %>%
  count(mom_present, dad_present) %>% 
  mutate(
    per = n / sum(n)
  )

d0_d1_follow %>%
  count(daycare_present) %>% 
  mutate(
    per = n / sum(n)
  )

d0_d1_follow %>%
  count(nanny_present) %>% 
  mutate(
    per = n / sum(n)
  )

d0_d1_follow %>%
  count(grandparent_present) %>% 
  mutate(
    per = n / sum(n)
  )

d0_d1_follow %>%
  count(friends_present) %>% 
  mutate(
    per = n / sum(n)
  )

d0_d1_follow %>%
  count(
    mom_present, 
    dad_present, 
    daycare_present, 
    nanny_present, 
    grandparent_present, 
    friends_present
  ) %>% 
  mutate(
    per = n / sum(n)
  )
```

```{r}
d0_d1_follow %>% 
  count(percent_mother)
```


```{r}
d0_d1_follow <-
  d0_d1_follow %>% 
  mutate(
    n_caregivers = 
      mom_present +
      dad_present +
      daycare_present +
      grandparent_present +
      nanny_present +
      friends_present
  )

t.test(d0_d1_follow$ctc_prop ~ d0_d1_follow$dad_present)
t.test(d0_d1_follow$ctc_prop ~ d0_d1_follow$grandparent_present)
```

```{r}
write_csv(d0_d1, "~/Desktop/BABIES/lena_symptoms/data_final/king_caregivinginput_itsea_20191119.csv")
```

