---
title: "Clean LENA 5-minute data"
output: html_notebook
---

## Environment set up

```{r load_data}
# Libraries
library(tidyverse)
library(lubridate)
library(hms)

# Files

## Fran file paths
lena_5min_file_1 <- "~/Desktop/lena_18mo_symptoms/Data_Final/LENAExport_5Minute_20181220_cleaned.csv"
lena_5min_file_2 <- "~/Desktop/lena_18mo_symptoms/Data_Final/LENAExport_5Minute_new_20190726.csv"
lena_5min_files <- "~/Desktop/lena_18mo_symptoms/Data_Final/individual_5min_lsk_format_cleaned"
lena_followup_long_file <- "~/Desktop/lena_18mo_symptoms/Data_Final/lena_followup_long_datecleaned_20190726.csv"
lena_followup_cs_file <- "~/Desktop/lena_18mo_symptoms/Data_Final/lena_followup_cs_datecleaned_20190216.csv"

## Lucy file
# lena_5min_file_1 <- "~/Desktop/BABIES/lena_symptoms/fran_box_data/LENAExport_5Minute_20181220_cleaned.csv"
# lena_5min_file_2 <- "~/Desktop/BABIES/lena_symptoms/fran_box_data/LENAExport_5Minute_new_20190510.csv"
# lena_5min_files <- "~/Desktop/BABIES/lena_symptoms/fran_box_data/individual_5min_lsk_format_cleaned"
# lena_followup_long_file <- "~/Desktop/BABIES/lena_symptoms/fran_box_data/lena_followup_long_datecleaned_20190412.csv"
# lena_followup_cs_file <- "~/Desktop/BABIES/lena_symptoms/fran_box_data/lena_followup_cs_datecleaned_20190216.csv"

lena_5min_files_df <-
  tibble(
    path = 
      list.files(
        path = lena_5min_files,
        all.files = TRUE,
        #pattern = "^LENA Export (5 Minute) \\d{3}_\\d{6}.csv$",
        no.. = TRUE,
        full.names = TRUE
      )
  ) %>% 
  filter(
    str_detect(path, "/.DS_Store") == FALSE
  )
```

# Read in and reformat 5 minute data

```{r}
lena_5min_sp <-
  read_csv(lena_5min_file_2) %>% 
  mutate(
    ExternalReferenceID = as.integer(ExternalReferenceID),
    Recording_DOB = as.character(Recording_DOB),
    StartTime = as.character(StartTime)
  ) %>% 
  select(
    ExternalReferenceID,
    Recording_DOB,
    StartTime,
    Duration_Secs,
    AWC_COUNT,
    CT_COUNT,
    CV_COUNT,
    Recording_Gender,
    Meaningful,
    Distant, 
    TV_Elec,
    Overlap,
    Noise,
    Silence
  ) %>% 
  mutate(
    ID = ExternalReferenceID,
    dob = Recording_DOB,
    AWC.Actual = AWC_COUNT,
    CTC.Actual = CT_COUNT,
    CVC.Actual = CV_COUNT,
    Sex = Recording_Gender,
    Duration = as.hms(Duration_Secs),
    Meaningful = as.hms(Meaningful),
    Distant = as.hms(Distant),
    TV = as.hms(TV_Elec),
    Overlap = as.hms(Overlap),
    Noise = as.hms(Noise),
    Silence = as.hms(Silence),
    Timestamp = StartTime
  ) %>% 
  select(
    -ExternalReferenceID,
    -Recording_DOB,
    -Recording_Gender,
    -CT_COUNT,
    -CV_COUNT,
    -AWC_COUNT,
    -Duration_Secs
  )
```

## Read in 5-minute data from Pro license 2 (2018 file) and SP

```{r warning=FALSE}
lena_5min <-
  read_csv(lena_5min_file_1) %>% 
  mutate(
    Birthdate = as.character(Birthdate),
    Timestamp = as.character(Timestamp),
    Meaningful = as.hms(Meaningful)
  ) %>% 
  select(
    -Type,
    -ChildKey,
    -Id,
    -Age,
    -AVA_StdScore:-AVA_AvgScore_Pct,
    -Firstname,
    ID = Lastname,
    dob = Birthdate
  ) %>% 
  bind_rows(
    lena_5min_sp
  ) %>% 
  separate(Timestamp, into = c("date_record", "time_record"), sep = " ") %>% 
  mutate(
    ID = as.numeric(ID),
    dob = parse_date_time(dob, c("ymd", "mdy")),
    date_record = parse_date_time(date_record, c("ymd", "mdy")),
    age = (dob %--% date_record) / months(1)
  ) %>% 
  select(
    -dob
  )
```

## Read in data from individual files (Pro license 1)

```{r warning=FALSE}
lena_5min2 <-
  lena_5min_files_df %>%
  mutate(
    data = map(
      path, 
      read_csv, 
      col_names = TRUE,
      col_types = 
        list(
          Firstname = col_character(),
          Birthdate = col_character(),
          Timestamp = col_character(),
          AVA_StdScore = col_character(),
          Lastname = col_character(),
          Sex = col_character(),
          ChildKey = col_character()
        )
      )
  ) %>% 
  unnest(data) %>% 
  select(-path) %>% 
  mutate(
    Birthdate = as.character(Birthdate),
    Timestamp = as.character(Timestamp)
  ) %>% 
  select(
    -Type,
    -ChildKey,
    -Id,
    -Age,
    -AVA_StdScore:-AVA_AvgScore_Pct,
    ID1 = Firstname,
    ID2 = Lastname,
    dob = Birthdate
  ) %>% 
  separate(Timestamp, into = c("date_record", "time_record"), sep = " ") %>% 
  mutate(
    ID = as.numeric(
      if_else(
        is.na(ID2),
        ID1, ID2
      )
    ),
    dob = parse_date_time(dob, c("ymd", "mdy")),
    date_record = parse_date_time(date_record, c("ymd", "mdy")),
    age = (dob %--% date_record) / months(1)
  ) %>% 
  select(
    ID,
    everything(),
    -ID1,
    -ID2,
    -dob
  )
```

## Combine all data
```{r}
lena_5min <-
  lena_5min %>% 
  bind_rows(lena_5min2) %>% 
  arrange(ID)
```

# Clean and wrangle 5-minute data 
Conditions to filter on: age between 5 and 8 months at time of recording, duration of recording at least 8 hours.

```{r}
lena_5min_cl <- 
  lena_5min %>% 
  group_by(ID) %>% 
  mutate(
    duration = as.numeric(
      as.duration(hms(as.numeric(Duration))),
      "hours"
    )
  ) %>% 
  group_by(ID, date_record, age) %>% 
  summarise(
    duration = sum(duration),
    awc_depend_sum = sum(AWC.Actual >= 1),
    ctc_depend_sum = sum(CTC.Actual >= 1),
    cvc_depend_sum = sum(CVC.Actual >= 1),
    awc_total = sum(AWC.Actual),
    ctc_total = sum(CTC.Actual),
    cvc_total = sum(CVC.Actual),
    awc_max = max(AWC.Actual),
    ctc_max = max(CTC.Actual),
    cvc_max = max(CVC.Actual)
  ) %>% 
  mutate(
    awc_daily_rate = awc_total/duration, #daily AWC rate
    ctc_daily_rate = ctc_total/duration, #daily CTC rate
    cvc_daily_rate = cvc_total/duration, #daily CVC rate
    awc_prop = (awc_depend_sum) / ((duration * 60) / 5), #proportion of 5 minute segments with AWC
    ctc_prop = (ctc_depend_sum) / ((duration * 60) / 5), #proportion of 5 minute segments with CTC 
    cvc_prop = (cvc_depend_sum) / ((duration * 60) / 5)
  ) %>% 
  filter(
    (age >= 5 & age <= 8),
    duration >= 8
  ) %>% 
  group_by(ID) %>% 
  mutate(
    day_type = wday(date_record),
    day_type = if_else(day_type == 1 | day_type == 7, "weekend", "weekday"),
    day = 1:n()
  ) %>% 
  ungroup()
```

# Create wideform data frame with 1 row per ID
```{r}
lena_5min_cl %>% 
  count(day)

lena_5min_day1_rename <-
  lena_5min_cl %>% 
  filter(day == 1) %>% 
  rename_at(
    vars(date_record:day_type),
    funs(paste0(., "_D1"))
  ) %>% 
  select(-day)

lena_5min_day2_rename <-
  lena_5min_cl %>% 
  filter(day == 2) %>% 
  rename_at(
    vars(date_record:day_type),
    funs(paste0(., "_D2"))
  ) %>% 
  select(-day)

lena_5min_cl_wf <-
  lena_5min_day1_rename %>% 
  left_join(lena_5min_day2_rename, by = "ID") %>% 
  group_by(ID) %>% 
  mutate(
    ctc_max_D1D2 = max(ctc_max_D1, ctc_max_D2, na.rm = TRUE)
  ) %>% 
  ungroup()
```

## Identifying problematic recordings:

__Deleted from raw data:__ 1052 5/8/18 recording, 62 Day 1 on 7/11/17 (from LENAExport_5minute_20181220). 
__Filter from analyses:__ 56 Day 1, 110 Day 2, use 106 day 1 (day 2 not typical), use 1052 day 2 (day 1 "went to zoo for 90 min" but doesn't say when), use 1045 day 2 (day 1 not whole day), 1010 use day 2 (mother worked 5 hrs day 1)

__Delete data with crowds:__ -cleaned from raw data (files renamed "_cleaned"). Recordings with crowds:

cross-sectional:
27 9/18/16 15-16:00 (5 min files)
119 4/19/18 11:30-12:30 (20181220)
135 9/13/18 13-13:30 (20181220)
38 2/10/17 16-18 (20181220)
48 3/5/17 11-13 (20181220)
61 7/18/17 13-15 (20181220)
62 7/30/17 9:30-10:30 (2018), 
76 8/21/17 15-16 (2018)
2 day 1 19:30-10 (5 min files)
28 day 1 13-15 (5 min files)
64 8/8/17 11-11:30 (2018)
75 9/15/17 12-15 (2018)
87 9/11/17 14:40-16:40 (2018)
105 3/15/18 16:45-16:55 (2018)
27 10/2/16 11-13 (5 min files)
19 5/12/18 13:30-17:30 (2018)
135 9/23/18 9-10:45 (2018)
12 day 2 12:20-13:50 (5 min files)
45 4/22/17 10:30-11:30 (2018)
50 3/18/17 9:45-12:45 (not completed correctly; entirely deleted)
60 7/16/17 14:30-16:30 (2018)
72 8/6/17 13-16 (2018)
94 4/15/18 12:30-14 (2018)
106 4/1/18 14:40-18:40 (2018)
115 4/14/18 13-14:30 (2018)

longitudinal: 
1029 4/6/18 18:40-20:40 (2018)
1021 6/25/18 18-19:30 (2018)
1078 6/15/18 17:30-19:30 (2018)
1028 4/17/18 15:30-16 (2018)
1036 3/22/18 13:15-15:15 (2018)
1045 4/22/18 10-12 (2018)
1010 2/8/18 9:15-14:15
1028 5/6/18 15-19 (2018)
1036 5/5/18 8-9 16-17 (2018)
1045 5/19/18 10:30-12:30 (2018)
1011 5/13/18 15-16 (2018)
1019 5/20/18 16-17 (2018)
1023 5/12/18 11-13 (2018)
1060 9/29/18 17:30-18:30 (2018)

# Count weekdays vs weekends
```{r}
lena_5min_cl_wf %>% 
  count(day_type_D1)

lena_5min_cl_wf %>% 
  count(day_type_D2)

lena_5min_cl_wf %>% 
  filter(day_type_D2 == "weekend" | day_type_D1 == "weekend")
```
Conclusion: 54 with weekend recording, so need to covary for day type (can't just use weekend from everyone); also many more weekends in day 2 than day 1

# Summarize proportion variables
```{r}
lena_5min_cl_wf %>% 
  summarise_at(
    vars(awc_prop_D1, ctc_prop_D1),
    funs(min, max, mean, sd), na.rm = TRUE
  )
```

# Read in LENA follow up data
```{r}
lena_followup <-
  read_csv(lena_followup_long_file) %>% 
  rename(ID = record_id) %>% 
  mutate(ID = as.integer(ID)) %>% 
  bind_rows(
    read_csv(lena_followup_cs_file) %>% 
      rename(ID = record_id) %>% 
      mutate(ID = as.integer(ID))
  ) %>% 
  filter(
    lena_day_1_followup_questions_complete == 2 | lena_day_2_followup_questions_complete == 2
  ) %>% 
  mutate(
    lena_weekend = lena_daytype
  )

#t-test weekday vs. weekend and percent of time spent w mom
t.test(percent_mother ~ lena_weekend, data = lena_followup)
```
#Filter data for use in lena_18mo_symptoms project analyses
filtering criteria: Day 1, removing 110
```{r}
#IDs to use day 2: 
# day 2: 110 (put device in pocket rather than chest day 1), 106

#110 day 2 isn't in dataset and 106 isn't in it at all, so taking day 1 from everyone:

lena_5min_cl_filtered <-
  lena_5min_cl %>%
  filter(
    ID != 110
  ) 
```

### Merge relevant follow up qs data with cleaned & filtered lena data 
```{r}
##add percent_mother variable to lena data to see if difference weekday vs. weekend within the subset of recordings we've filtered, joining on ID and day_type

lena_5min_cl_filtered <-
  lena_5min_cl_filtered %>% 
  mutate(
    day_weekend_num = if_else(
      day_type == "weekend",
      1, 0
    )
  ) %>% 
  rename(
    baby_age_lena = age
  )
  
#merge data on lena recording date 
lena_followup_and_data <- 
  lena_5min_cl_filtered %>%  
  mutate(
    date_record = parse_date_time(date_record, c("ymd", "mdy"))
  ) %>% 
  left_join(
    lena_followup %>% 
      rename(date_record = lenaday_date) %>% 
      mutate(
        date_record = parse_date_time(date_record, c("ymd", "mdy"))
      ), 
    by = c("ID", "date_record")
  ) 

```

##Write file with relevant data 

```{r}
#all data
#write_csv(lena_5min_cl, "~/Desktop/lena_18mo_symptoms/Data/lena_cleaned_byday_20190413.csv")
#write_csv(lena_5min_cl_wf, "~/Desktop/lena_18mo_symptoms/Data/lena_cleaned_byID_20190202.csv")

#write_csv(lena_5min_cl_wf, "~/Desktop/BABIES/data/lena_data/lena_cleaned_wf_20190308.csv")
#write_csv(lena_5min_cl_filtered, "~/Desktop/lena_18mo_symptoms/Data/lena_cleaned_day1_20190510.csv")
#write_csv(lena_followup_and_data, "~/Desktop/BABIES/lena_symptoms/fran_box_data/lena_followup_and_data_20190510.csv")
write_csv(lena_followup_and_data, "~/Desktop/lena_18mo_symptoms/Data_Final/lena_followup_and_data_20190726.csv")
```