---
title: "Clean LENA 5-minute data"
author: "Lucy King & Fran Querdasi"
output: html_notebook
---

## Environment set up

```{r load_data}
# Libraries
library(tidyverse)
library(lubridate)
library(hms)
library(psych)

# Files

lena_5min_file_1 <- "~/Desktop/BABIES/lena_symptoms/data_final/LENAExport_5Minute_20181220_cleaned.csv"
lena_5min_file_2 <- "~/Desktop/BABIES/lena_symptoms/data_final/LENAExport_5Minute_new_20190726.csv"
lena_5min_files <- "~/Desktop/BABIES/lena_symptoms/data_final/individual_5min_lsk_format_cleaned"
lena_followup_long_file <- "~/Desktop/BABIES/lena_symptoms/data_final/lena_followup_long_datecleaned_20190726.csv"
lena_followup_cs_file <- "~/Desktop/BABIES/lena_symptoms/data_final/lena_followup_cs_datecleaned_20190216.csv"

lena_5min_files_df <-
  tibble(
    path = 
      list.files(
        path = lena_5min_files,
        all.files = TRUE,
        #pattern = "^LENA Export (5 Minute) \\d{3}_\\d{6}.csv$",
        no.. = TRUE,
        full.names = TRUE
      )
  ) %>% 
  filter(
    str_detect(path, "/.DS_Store") == FALSE
  )


# Functions
source("~/Desktop/BABIES/lena_symptoms/lena_18mo_symptoms/identify_outliers_histogram.R")
source("~/Desktop/BABIES/lena_symptoms/lena_18mo_symptoms/winsorize.R")


# Themes
theme_lena <-
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 18, hjust = .5),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 16),
    legend.title = element_text(size = 18), 
    legend.text = element_text(size = 16),
    legend.position = "bottom"
  )
```

# Read in and reformat 5 minute data from LENA SP 

```{r}
lena_5min_sp <-
  read_csv(lena_5min_file_2) %>% 
  mutate(
    ExternalReferenceID = as.integer(ExternalReferenceID),
    Recording_DOB = as.character(Recording_DOB),
    StartTime = as.character(StartTime)
  ) %>% 
  select(
    ExternalReferenceID,
    Recording_DOB,
    StartTime,
    Duration_Secs,
    AWC_COUNT,
    CT_COUNT,
    CV_COUNT,
    Recording_Gender,
    Meaningful,
    Distant, 
    TV_Elec,
    Overlap,
    Noise,
    Silence
  ) %>% 
  mutate(
    ID = ExternalReferenceID,
    dob = Recording_DOB,
    AWC.Actual = AWC_COUNT,
    CTC.Actual = CT_COUNT,
    CVC.Actual = CV_COUNT,
    Sex = Recording_Gender,
    Duration = as.hms(Duration_Secs),
    Meaningful = as.hms(Meaningful),
    Distant = as.hms(Distant),
    TV = as.hms(TV_Elec),
    Overlap = as.hms(Overlap),
    Noise = as.hms(Noise),
    Silence = as.hms(Silence),
    Timestamp = StartTime
  ) %>% 
  select(
    -ExternalReferenceID,
    -Recording_DOB,
    -Recording_Gender,
    -CT_COUNT,
    -CV_COUNT,
    -AWC_COUNT,
    -Duration_Secs
  ) %>% 
  mutate(
    Timestamp = str_replace(Timestamp, " \\(America/Los_Angeles\\)", ""),
    time_record = parse_date_time(Timestamp, "mdy HMS p!")
  ) %>% 
  select(
    -Timestamp
  )
```

## Read in 5-minute LENA Pro data and combine with LENA SP data 

```{r warning=FALSE}
lena_5min <-
  read_csv(lena_5min_file_1) %>% 
  mutate(
    Birthdate = as.character(Birthdate),
    Timestamp = as.character(Timestamp),
    Meaningful = as.hms(Meaningful)
  ) %>% 
  select(
    -Type,
    -ChildKey,
    -Id,
    -Age,
    -AVA_StdScore:-AVA_AvgScore_Pct,
    -Firstname,
    ID = Lastname,
    dob = Birthdate
  ) %>% 
  mutate(
    time_record = parse_date_time(Timestamp, "mdy HM")
  ) %>% 
  bind_rows(
    lena_5min_sp
  ) %>% 
  mutate(
    ID = as.numeric(ID)
  ) %>% 
  select(
    -Timestamp
  )
```

## Read in data from individual files (Pro license 1)

```{r warning=FALSE}
lena_5min2 <-
  lena_5min_files_df %>%
  mutate(
    data = map(
      path, 
      read_csv, 
      col_names = TRUE,
      col_types = 
        list(
          Firstname = col_character(),
          Birthdate = col_character(),
          Timestamp = col_character(),
          AVA_StdScore = col_character(),
          Lastname = col_character(),
          Sex = col_character(),
          ChildKey = col_character()
        )
      )
  ) %>% 
  unnest(data) %>% 
  select(-path) %>% 
  mutate(
    Birthdate = as.character(Birthdate),
    Timestamp = as.character(Timestamp)
  ) %>% 
  select(
    -Type,
    -ChildKey,
    -Id,
    -Age,
    -AVA_StdScore:-AVA_AvgScore_Pct,
    ID1 = Firstname,
    ID2 = Lastname,
    dob = Birthdate
  ) %>% 
  mutate(
    ID = as.numeric(
      if_else(
        is.na(ID2),
        ID1, ID2
      )
    ),
    time_record = parse_date_time(Timestamp, c("mdy HM", "ymd HM"))
  ) %>% 
  select(
    ID,
    everything(),
    -Timestamp,
    -ID1,
    -ID2
  )
```

## Combine all data
```{r}
lena_5min <-
  lena_5min %>% 
  bind_rows(lena_5min2) %>% 
  arrange(ID) %>% 
  mutate(
    dob = parse_date_time(dob, c("Ymd", "mdy")),
    date_record = date(time_record),
    age = (dob %--% date_record) / months(1)
  )
```

## Create long-form data frame with time variables
```{r}
lena_time <- 
  lena_5min %>% 
  group_by(ID) %>% 
  mutate(
    time_hours = hour(time_record) + minute(time_record) / 60,
    duration = as.numeric(
      as.duration(hms(as.numeric(Duration))),
      "hours"
    )
  ) 
```

# Clean and wrangle 5-minute data 
Conditions to filter on: age between 5 and 8 months at time of recording, duration of recording at least 8 hours.

```{r}
lena_5min_cl <- 
  lena_5min %>% 
  group_by(ID) %>% 
  mutate(
    duration = as.numeric(
      as.duration(hms(as.numeric(Duration))),
      "hours"
    )
  ) %>% 
  group_by(ID, date_record, age) %>% 
  summarise(
    duration = sum(duration),
    awc_depend_sum = sum(AWC.Actual >= 1),
    ctc_depend_sum = sum(CTC.Actual >= 1),
    cvc_depend_sum = sum(CVC.Actual >= 1),
    awc_total = sum(AWC.Actual),
    ctc_total = sum(CTC.Actual),
    cvc_total = sum(CVC.Actual),
    awc_max = max(AWC.Actual),
    ctc_max = max(CTC.Actual),
    cvc_max = max(CVC.Actual)
  ) %>% 
  mutate(
    awc_daily_rate_dur = awc_total/duration, #daily AWC rate
    ctc_daily_rate_dur = ctc_total/duration, #daily CTC rate
    cvc_daily_rate_dur = cvc_total/duration, #daily CVC rate
    awc_prop_dur = (awc_depend_sum) / ((duration * 60) / 5), #proportion of 5 minute segments with AWC
    ctc_prop_dur = (ctc_depend_sum) / ((duration * 60) / 5), #proportion of 5 minute segments with CTC 
    cvc_prop_dur = (cvc_depend_sum) / ((duration * 60) / 5)
  ) %>% 
  ungroup()
```

```{r}
lena_5min_cl <-
  lena_5min_cl %>% 
  group_by(ID) %>% 
  mutate(
    day_type = wday(date_record),
    day_type = if_else(day_type == 1 | day_type == 7, "weekend", "weekday"),
    day = 1:n()
  ) %>% 
  ungroup()
```

```{r}
# identify who will be dropped

## based on age
lena_5min_cl %>%
  filter(day == 1) %>% 
  count(age > 8)

lena_5min_cl %>%
  filter(day == 1 & age > 8)

## based on duration
lena_5min_cl %>%
  filter(day == 1) %>% 
  count(duration < 8)

lena_5min_cl %>%
  filter(day == 1 & duration < 8)

# ID 012 did not end up being dropped because day 2 was usable 
```

```{r}
lena_5min_cl <-
  lena_5min_cl %>% 
  filter(
    (age >= 5 & age <= 8),
    duration >= 8
  ) 
```

# Create wideform data frame with 1 row per ID
```{r}
lena_5min_day1_rename <-
  lena_5min_cl %>% 
  filter(day == 1) %>% 
  rename_at(
    vars(date_record:day_type),
    list(~paste0(., "_D1"))
  ) %>% 
  select(-day)

lena_5min_day2_rename <-
  lena_5min_cl %>% 
  filter(day == 2) %>% 
  rename_at(
    vars(date_record:day_type),
    list(~paste0(., "_D2"))
  ) %>% 
  select(-day)

lena_5min_cl_wf <-
  lena_5min_day1_rename %>% 
  left_join(lena_5min_day2_rename, by = "ID") %>% 
  distinct(ID, date_record_D1, ctc_daily_rate_dur_D1, .keep_all = TRUE) %>% 
  group_by(ID) %>% 
  mutate(
    ctc_max_D1D2 = max(ctc_max_D1, ctc_max_D2, na.rm = TRUE)
  ) %>% 
  ungroup()
```

## Identifying problematic recordings:

__Deleted from raw data:__ 1052 5/8/18 recording, 62 Day 1 on 7/11/17 (from LENAExport_5minute_20181220). 
__Filter from analyses:__ 56 Day 1, 110 Day 2, use 106 day 1 (day 2 not typical), use 1052 day 2 (day 1 "went to zoo for 90 min" but doesn't say when), use 1045 day 2 (day 1 not whole day), 1010 use day 2 (mother worked 5 hrs day 1)

__Delete data with crowds:__ -cleaned from raw data (files renamed "_cleaned"). Recordings with crowds:

cross-sectional:
27 9/18/16 15-16:00 (5 min files)
119 4/19/18 11:30-12:30 (20181220)
135 9/13/18 13-13:30 (20181220)
38 2/10/17 16-18 (20181220)
48 3/5/17 11-13 (20181220)
61 7/18/17 13-15 (20181220)
62 7/30/17 9:30-10:30 (2018), 
76 8/21/17 15-16 (2018)
2 day 1 19:30-10 (5 min files)
28 day 1 13-15 (5 min files)
64 8/8/17 11-11:30 (2018)
75 9/15/17 12-15 (2018)
87 9/11/17 14:40-16:40 (2018)
105 3/15/18 16:45-16:55 (2018)
27 10/2/16 11-13 (5 min files)
19 5/12/18 13:30-17:30 (2018)
135 9/23/18 9-10:45 (2018)
12 day 2 12:20-13:50 (5 min files)
45 4/22/17 10:30-11:30 (2018)
50 3/18/17 9:45-12:45 (not completed correctly; entirely deleted)
60 7/16/17 14:30-16:30 (2018)
72 8/6/17 13-16 (2018)
94 4/15/18 12:30-14 (2018)
106 4/1/18 14:40-18:40 (2018)
115 4/14/18 13-14:30 (2018)

longitudinal: 
1029 4/6/18 18:40-20:40 (2018)
1021 6/25/18 18-19:30 (2018)
1078 6/15/18 17:30-19:30 (2018)
1028 4/17/18 15:30-16 (2018)
1036 3/22/18 13:15-15:15 (2018)
1045 4/22/18 10-12 (2018)
1010 2/8/18 9:15-14:15
1028 5/6/18 15-19 (2018)
1036 5/5/18 8-9 16-17 (2018)
1045 5/19/18 10:30-12:30 (2018)
1011 5/13/18 15-16 (2018)
1019 5/20/18 16-17 (2018)
1023 5/12/18 11-13 (2018)
1060 9/29/18 17:30-18:30 (2018)

# Count weekdays vs weekends
```{r}
lena_5min_cl_wf %>% 
  count(day_type_D1)
```


# Read in LENA follow up data
```{r}
lena_followup <-
  read_csv(lena_followup_long_file) %>% 
  rename(ID = record_id) %>% 
  mutate(ID = as.integer(ID)) %>% 
  select(
    ID,
    lena_caregivers___1:percent_mother,
    lena_notes,
    lena_day_1_followup_questions_complete
  ) %>% 
  filter(lena_day_1_followup_questions_complete == 2) %>% 
  bind_rows(
    read_csv(lena_followup_cs_file) %>% 
      rename(ID = record_id) %>% 
      mutate(
        ID = as.integer(ID), 
        lena_day_1_followup_questions_complete = as.integer(lena_day_1_followup_questions_complete)
      ) %>% 
      select(
        ID,
        lena_caregivers___1:percent_mother,
        lena_notes,
        lena_day_1_followup_questions_complete
      ) %>% 
      filter(lena_day_1_followup_questions_complete == 2)
  ) 
```

```{r}
#IDs to use day 2: 
# 110 (put device in pocket rather than chest day 1)

lena_5min_cl <-
  lena_5min_cl %>%
  mutate(
    day = if_else(
      ID == 110 & day == 1,
      NA_integer_, day
    ),
    day = if_else(
      ID == 110 & day == 2,
      as.integer(1), day
    )
  )
```

## Merge relevant follow up qs data with cleaned & filtered lena data 
```{r}
lena_5min_cl <-
  lena_5min_cl %>% 
  mutate(
    day_weekend_num = if_else(
      day_type == "weekend",
      1, 0
    )
  ) %>% 
  rename(
    baby_age_lena = age
  )
  
lena_followup_and_data <- 
  lena_5min_cl %>%  
  mutate(
    date_record = parse_date_time(date_record, c("ymd", "mdy"))
  ) %>% 
  left_join(
    lena_followup,
    by = c("ID")
  ) 

```

## Filter to only day 1 data
```{r}
lena_d1 <- 
  lena_followup_and_data %>% 
  filter(day == 1) 
```

## Clean LENA time data 
```{r}
ids_dates <-
  lena_d1 %>% 
  select(
    ID,
    date_record
  ) %>% 
  mutate(
    included = 1,
    date_record = date(date_record)
  )

lena_time_cl <-
  lena_time %>% 
  left_join(ids_dates, by = c("ID", "date_record")) %>% 
  filter(included == 1)
```

## Identify value and times of first and last CT and AW of the day
```{r}
lena_time_cl <-
  lena_time_cl %>% 
  arrange(ID, time_hours) %>% 
  group_by(ID) %>% 
  mutate(
    # first ct
    ct_first_row = head(which(CTC.Actual != 0), 1),
    ct_first = nth(CTC.Actual, n = ct_first_row[1]),
    ct_first_time = nth(time_hours, n = ct_first_row[1]),
    # last ct
    ct_last_row = tail(which(CTC.Actual != 0), 1),
    ct_last = nth(CTC.Actual, n = ct_last_row[1]),
    ct_last_time = nth(time_hours, n = ct_last_row[1]),
    # first aw
    aw_first_row = head(which(AWC.Actual != 0), 1),
    aw_first = nth(AWC.Actual, n = aw_first_row[1]),
    aw_first_time = nth(time_hours, n = aw_first_row[1]),
    # last aw
    aw_last_row = tail(which(AWC.Actual != 0), 1),
    aw_last = nth(AWC.Actual, n = aw_last_row[1]),
    aw_last_time = nth(time_hours, n = aw_last_row[1]),
    # create grouping variable for time of day 
    time_day = case_when(
      time_hours >= ct_first_time & time_hours <= 10 ~ "AM",
      time_hours >= 10 & time_hours < 13 ~ "MID",
      time_hours >= 13 & time_hours < 17 ~ "AFT",
      time_hours >= 17 & time_hours < ct_last_time ~ "PM"
    )
  ) %>% 
  select(-ct_last_row, -aw_last_row, -ct_first_row, -aw_first_row) 
```

  
``` {r}
# calculate rates and consistency during each phase of day 
lena_time_day <- 
  lena_time_cl %>% 
  group_by(ID, date_record, time_day, age) %>% 
  summarise(
    duration_time_day = sum(duration),
    ctc_time_day = sum(CTC.Actual),
    awc_time_day = sum(AWC.Actual),
    ctc_depend_time_day = sum(CTC.Actual >= 1),
    awc_depend_time_day = sum(AWC.Actual >= 1),
  ) %>% 
  ungroup() %>% 
  filter(!is.na(time_day)) %>% 
  group_by(ID) %>% 
  mutate(
    ctc_time_rate = ctc_time_day / duration_time_day,
    awc_time_rate = awc_time_day / duration_time_day,
    ctc_time_prop = ctc_depend_time_day / ((duration_time_day * 60) / 5),
    awc_time_prop = awc_depend_time_day / ((duration_time_day * 60) / 5)
  ) %>% 
  # these IDs are missing a time segment on day 1 therefore 1 of the time segments on day 2 was counted
  filter(
    !(ID == 1033 & date_record == ymd("2018-03-27")) ,
    !(ID == 1045 & date_record == ymd("2018-05-19")),
    !(ID == 1029 & date_record == ymd("2018-05-12"))
  )

lena_time_wf <- 
  lena_time_day %>%
  select(
    ID,
    time_day,
    ctc_time_rate:awc_time_prop
  ) %>% 
  gather(variable, value, ctc_time_rate:awc_time_prop) %>% 
  unite(temp, time_day, variable) %>% 
  spread(temp, value) %>% 
  rename_at(
    vars(-ID),
    list(~str_replace(., "time_", ""))
  ) %>% 
  mutate(
    ctc_daily_rate = mean(
      c(
        AFT_ctc_rate,
        AM_ctc_rate,
        MID_ctc_rate,
        PM_ctc_rate
      ),
      na.rm = TRUE
    ),
    awc_daily_rate = mean(
      c(
        AFT_awc_rate,
        AM_awc_rate,
        MID_awc_rate,
        PM_awc_rate
      ),
      na.rm = TRUE
    ),
    ctc_prop = mean(
      c(
        AFT_ctc_prop,
        AM_ctc_prop,
        MID_ctc_prop,
        PM_ctc_prop
      ),
      na.rm = TRUE
    ),
    awc_prop = mean(
      c(
        AFT_awc_prop,
        AM_awc_prop,
        MID_awc_prop,
        PM_awc_prop
      ),
      na.rm = TRUE
    )
  )


```


## Merge time data 
```{r}
lena_d1 <-
  lena_d1 %>% 
  distinct(ID, ctc_daily_rate_dur, .keep_all = TRUE) %>% 
  left_join(lena_time_wf, by = "ID") 
```

# Summarize proportion variables
```{r}
lena_5min_cl_wf %>% 
  summarise_at(
    vars(awc_prop_dur_D1, ctc_prop_dur_D1),
    funs(min, max, mean, sd), na.rm = TRUE
  )
```

## Histograms
```{r}
identify_outliers_hist(lena_d1, ctc_daily_rate)
identify_outliers_hist(lena_d1, awc_daily_rate)
identify_outliers_hist(lena_d1, ctc_prop)
identify_outliers_hist(lena_d1, awc_prop)
identify_outliers_hist(lena_d1, AM_ctc_rate)
identify_outliers_hist(lena_d1, MID_ctc_rate)
identify_outliers_hist(lena_d1, AFT_ctc_rate)
identify_outliers_hist(lena_d1, PM_ctc_rate)
```

```{r}
# join first and last variables with day 1 LENA data 
lena_d1 <-
  lena_d1 %>% 
  left_join(
    lena_time_cl %>% 
      select(
        ID, 
        ct_last, 
        ct_last_time, 
        aw_last, 
        aw_last_time,
        ct_first,
        ct_first_time,
        aw_first,
        aw_first_time
        ) %>% 
      distinct(ID, ct_last, .keep_all = TRUE),
    by = "ID"
  ) 
```

## Histograms
```{r}
lena_time_cl %>% 
  ggplot(aes(time_hours, CTC.Actual)) +
  geom_jitter(alpha = 1/6, aes(color = time_day)) +
  geom_smooth(color = "black") +
  scale_x_continuous(breaks = seq.int(0, 24, 2)) +
  scale_y_continuous(breaks = seq.int(0, 35, 5)) +
  theme_lena +
  theme(
    legend.position = "none"
  ) +
  labs(
    x = "Time of day\n(hours since midnight)",
    y = "Conversational turn count"
  )

ggsave("~/Desktop/BABIES/lena_symptoms/manuscript/ctc_time_d1.png")

lena_time_cl %>% 
  ggplot(aes(time_hours, AWC.Actual)) +
  geom_jitter(alpha = 1/6, aes(color = time_day)) +
  geom_smooth(color = "black") +
  scale_x_continuous(breaks = seq.int(0, 24, 2)) +
  scale_y_continuous(breaks = seq.int(0, 1500, 200)) +
  theme_lena +
  theme(
    legend.position = "none"
  ) +
  labs(
    x = "Time of day\n(hours since midnight)",
    y = "Adult word turn count"
  )

ggsave("~/Desktop/BABIES/lena_symptoms/manuscript/awc_time_d1.png")
```

```{r}
missing_lena_ages <- 
  lena_5min %>% 
  left_join(ids_dates, by = c("ID", "date_record")) %>% 
  filter(is.na(included)) %>% 
  distinct(ID, age)
```

## Write file 

```{r}
write_csv(lena_d1, "~/Desktop/BABIES/lena_symptoms/data_final/lena_d1_20191015.csv")
write_csv(lena_time_cl, "~/Desktop/BABIES/lena_symptoms/data_final/lena_d1_time_20191015.csv")
```